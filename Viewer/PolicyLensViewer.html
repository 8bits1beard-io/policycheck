<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolicyLens Viewer</title>
    <style>
        :root {
            --bg-primary: #1e1e2e;
            --bg-secondary: #2a2a3e;
            --bg-card: #313145;
            --text-primary: #e0e0e8;
            --text-secondary: #a0a0b8;
            --accent-blue: #5b9bd5;
            --accent-green: #6bc96b;
            --accent-yellow: #e5c07b;
            --accent-red: #e06c75;
            --accent-cyan: #56b6c2;
            --accent-magenta: #c678dd;
            --border-color: #404060;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: var(--accent-blue);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .report-header {
            border-bottom: 2px solid var(--accent-blue);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .report-header .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-enrolled {
            background-color: var(--accent-green);
            color: #1e1e2e;
        }

        .badge-not-enrolled {
            background-color: var(--accent-red);
            color: #1e1e2e;
        }

        .badge-warning {
            background-color: var(--accent-yellow);
            color: #1e1e2e;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 18px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .summary-card .number {
            font-size: 2rem;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }

        .summary-card .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .summary-card.green .number { color: var(--accent-green); }
        .summary-card.yellow .number { color: var(--accent-yellow); }
        .summary-card.red .number { color: var(--accent-red); }
        .summary-card.cyan .number { color: var(--accent-cyan); }
        .summary-card.magenta .number { color: var(--accent-magenta); }
        .summary-card.blue .number { color: var(--accent-blue); }

        .summary-card .description {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Summary Sections - Grouped card layout */
        .summary-section {
            margin-bottom: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .summary-section-header {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .summary-section .summary-grid {
            margin-bottom: 0;
        }

        .summary-card.status .number {
            font-size: 1.2rem;
        }

        .summary-card.status .status-icon {
            display: inline-block;
            margin-right: 6px;
        }

        .summary-card.status .status-icon.check::before {
            content: "\2713";
        }

        /* Small clickable summary cards */
        .summary-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 0;
        }

        .summary-card-small {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .summary-card-small:hover {
            border-color: var(--accent-cyan);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .summary-card-small .number {
            font-size: 1.4rem;
            font-weight: 700;
            display: block;
            margin-bottom: 3px;
        }

        .summary-card-small .label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .summary-card-small.green .number { color: var(--accent-green); }
        .summary-card-small.red .number { color: var(--accent-red); }
        .summary-card-small.cyan .number { color: var(--accent-cyan); }
        .summary-card-small.blue .number { color: var(--accent-blue); }
        .summary-card-small.magenta .number { color: var(--accent-magenta); }

        .summary-card.status .status-icon.x::before {
            content: "\2717";
            color: var(--accent-red);
        }

        /* Welcome Panel */
        .welcome-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px 25px;
            margin-bottom: 20px;
        }

        .welcome-panel h2 {
            color: var(--accent-blue);
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .welcome-panel p {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .welcome-panel ul {
            list-style-type: none;
            padding: 0;
        }

        .welcome-panel li {
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
            color: var(--text-primary);
        }

        .welcome-panel li::before {
            content: "\2022";
            color: var(--accent-blue);
            position: absolute;
            left: 0;
        }

        /* Callouts */
        .callout {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .callout.warning {
            background: rgba(224, 108, 117, 0.1);
            border: 1px solid var(--accent-red);
        }

        .callout.info {
            background: rgba(86, 182, 194, 0.1);
            border: 1px solid var(--accent-cyan);
        }

        .callout-icon {
            font-size: 1.3rem;
        }

        .callout-text {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        /* Legend Box */
        .legend-box {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .legend-box .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        .legend-color.match { background: var(--accent-green); }
        .legend-color.conflict { background: var(--accent-red); }
        .legend-color.migration { background: var(--accent-cyan); }
        .legend-color.nomapping { background: var(--accent-magenta); }

        .legend-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .legend-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Info box explanation variant */
        .info-box.explanation {
            background: rgba(91, 155, 213, 0.08);
            border-left: 3px solid var(--accent-blue);
            color: var(--text-secondary);
        }

        /* Category Dividers */
        .category-divider {
            display: flex;
            align-items: center;
            margin: 40px 0 20px 0;
            gap: 15px;
        }

        .category-divider-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--border-strong), transparent);
        }

        .category-divider-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        /* Collapsible Sections */
        .section {
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .section-header {
            background: var(--bg-card);
            padding: 14px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background-color 0.2s;
        }

        .section-header:hover {
            background: #3a3a50;
        }

        .section-header h2 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin: 0;
        }

        .section-header .toggle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        .section-header.collapsed .toggle {
            transform: rotate(-90deg);
        }

        .section-body {
            padding: 15px 20px;
        }

        .section-body.hidden {
            display: none;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            text-align: left;
            padding: 10px 12px;
            background: var(--bg-card);
            color: var(--accent-blue);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
        }

        td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }

        tr:hover td {
            background: rgba(91, 155, 213, 0.05);
        }

        /* Status rows */
        tr.status-both-match td {
            border-left: 3px solid var(--accent-green);
        }

        tr.status-both-conflict td {
            border-left: 3px solid var(--accent-red);
            background: rgba(224, 108, 117, 0.08);
        }

        tr.status-gpo-mapping td {
            border-left: 3px solid var(--accent-cyan);
        }

        tr.status-gpo-nomapping td {
            border-left: 3px solid var(--accent-magenta);
        }

        tr.status-mdm-only td {
            border-left: 3px solid var(--accent-blue);
        }

        tr.suggestion-row td {
            padding: 0;
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-yellow);
        }

        /* Status badges in tables */
        .status-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-tag.both-match {
            background: rgba(107, 201, 107, 0.2);
            color: var(--accent-green);
        }

        .status-tag.conflict {
            background: rgba(224, 108, 117, 0.2);
            color: var(--accent-red);
        }

        .status-tag.migration-ready {
            background: rgba(86, 182, 194, 0.2);
            color: var(--accent-cyan);
        }

        .status-tag.no-mapping {
            background: rgba(198, 120, 221, 0.2);
            color: var(--accent-magenta);
        }

        .status-tag.mdm-only {
            background: rgba(91, 155, 213, 0.2);
            color: var(--accent-blue);
        }

        /* Deployment Verification Status Tags */
        .status-tag.applied {
            background: rgba(107, 201, 107, 0.2);
            color: var(--accent-green);
        }

        .status-tag.pending {
            background: rgba(86, 182, 194, 0.2);
            color: var(--accent-cyan);
        }

        .status-tag.not-applied {
            background: rgba(224, 108, 117, 0.2);
            color: var(--accent-red);
        }

        .status-tag.error {
            background: rgba(224, 108, 117, 0.3);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .status-tag.installed {
            background: rgba(107, 201, 107, 0.2);
            color: var(--accent-green);
        }

        .status-tag.not-installed {
            background: rgba(160, 160, 184, 0.2);
            color: var(--text-secondary);
        }

        .status-tag.unknown {
            background: rgba(160, 160, 184, 0.2);
            color: var(--text-secondary);
        }

        /* Verification row status classes */
        tr.status-applied td {
            border-left: 3px solid var(--accent-green);
        }

        tr.status-pending td {
            border-left: 3px solid var(--accent-cyan);
        }

        tr.status-not-applied td {
            border-left: 3px solid var(--accent-red);
        }

        tr.status-error td {
            border-left: 3px solid var(--accent-red);
            background: rgba(224, 108, 117, 0.08);
        }

        /* Info boxes */
        .info-box {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .info-box.info {
            background: rgba(91, 155, 213, 0.1);
            border-left: 3px solid var(--accent-blue);
        }

        .info-box.warning {
            background: rgba(229, 192, 123, 0.1);
            border-left: 3px solid var(--accent-yellow);
        }

        .info-box.success {
            background: rgba(107, 201, 107, 0.1);
            border-left: 3px solid var(--accent-green);
        }

        /* Filter/Search */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-bar input {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            flex: 1;
            min-width: 200px;
        }

        .filter-bar input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .filter-bar select {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Enrollment details */
        .enrollment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .enrollment-item {
            padding: 8px 0;
        }

        .enrollment-item .key {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .enrollment-item .value {
            font-size: 1rem;
            color: var(--text-primary);
            word-break: break-all;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-dot.green { background: var(--accent-green); }
        .legend-dot.red { background: var(--accent-red); }
        .legend-dot.cyan { background: var(--accent-cyan); }
        .legend-dot.magenta { background: var(--accent-magenta); }
        .legend-dot.blue { background: var(--accent-blue); }

        /* App assignments section */
        .app-card {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }

        .app-card .app-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .app-card .app-type {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .app-card .app-intent {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 4px;
        }

        .app-card .app-intent.required {
            background: rgba(91, 155, 213, 0.2);
            color: var(--accent-blue);
        }

        .app-card .app-intent.available {
            background: rgba(107, 201, 107, 0.2);
            color: var(--accent-green);
        }

        /* Group memberships */
        .group-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .group-chip {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 4px 14px;
            font-size: 0.85rem;
        }

        .group-chip.dynamic {
            border-color: var(--accent-cyan);
        }

        .group-chip.assigned {
            border-color: var(--accent-blue);
        }

        /* Footer */
        .report-footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-align: center;
        }

        /* Drop zone */
        .drop-zone {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
            background: var(--bg-secondary);
        }
        .drop-zone.drag-over {
            border-color: var(--accent-blue);
            background: rgba(91, 155, 213, 0.1);
        }
        .drop-zone h2 { color: var(--text-primary); margin-bottom: 10px; }
        .drop-zone p { color: var(--text-secondary); }

        /* Device cards in upload view */
        .device-cards { display: flex; gap: 15px; flex-wrap: wrap; margin: 20px 0; }
        .device-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 200px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .device-card:hover { border-color: var(--accent-blue); }
        .device-card.selected { border-color: var(--accent-green); background: rgba(107, 201, 107, 0.1); }
        .device-card .name { font-weight: 600; color: var(--text-primary); }
        .device-card .info { font-size: 0.85rem; color: var(--text-secondary); }
        .device-card .remove {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: var(--accent-red);
            font-size: 1.2rem;
            line-height: 1;
        }
        .device-card .remove:hover { opacity: 0.7; }

        /* Comparison grid */
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .compare-column { min-width: 0; }
        .compare-header {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Diff highlighting */
        .diff-unique-a { background: rgba(224, 108, 117, 0.15); }
        .diff-unique-b { background: rgba(107, 201, 107, 0.15); }
        .diff-value-mismatch { background: rgba(229, 192, 123, 0.15); }
        .diff-identical { }

        /* Action buttons */
        .btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); }

        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .tab {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .tab.active { background: var(--bg-card); color: var(--text-primary); border-bottom-color: var(--bg-card); }

        /* View containers */
        .view { display: none; }
        .view.active { display: block; }

        /* Navigation */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-bar h1 { margin-bottom: 0; }

        .nav-actions { display: flex; gap: 10px; }

        /* File input styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        /* Table wrapper for scroll */
        .table-wrapper {
            max-height: 500px;
            overflow-y: auto;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                color: #333;
                padding: 10px;
            }

            .section-header { cursor: default; }
            .section-body { display: block !important; }

            .summary-card {
                border: 1px solid #ccc;
                background: #f9f9f9;
            }

            tr.status-both-conflict td { background: #ffe0e0; }
            tr.status-gpo-mapping td { background: #e0f5f5; }
            tr.status-gpo-nomapping td { background: #f0e0f5; }
        }

        /* Welcome Panel */
        .welcome-panel {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px 30px;
            margin-bottom: 25px;
        }
        .welcome-panel h2 {
            color: var(--accent-blue);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        .welcome-panel p {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.7;
        }
        .welcome-panel ul {
            list-style: none;
            padding: 0;
        }
        .welcome-panel li {
            color: var(--text-primary);
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }
        .welcome-panel li::before {
            content: "â€¢";
            color: var(--accent-blue);
            position: absolute;
            left: 0;
        }

        /* Summary Card Descriptions */
        .summary-card .description {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 5px;
            line-height: 1.3;
        }

        /* Info Boxes - Enhanced */
        .info-box.explanation {
            background: rgba(91, 155, 213, 0.1);
            border-left: 3px solid var(--accent-blue);
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 0 6px 6px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Legend Box */
        .legend-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        .legend-color.match { background: var(--accent-green); }
        .legend-color.conflict { background: var(--accent-red); }
        .legend-color.migration { background: var(--accent-cyan); }
        .legend-color.nomapping { background: var(--accent-magenta); }
        .legend-label { color: var(--text-primary); font-weight: 500; }
        .legend-desc { color: var(--text-secondary); font-size: 0.8rem; }

        /* Callout Banners */
        .callout {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .callout-icon {
            font-size: 1.3rem;
        }
        .callout.warning {
            background: rgba(224, 108, 117, 0.15);
            border: 1px solid var(--accent-red);
        }
        .callout.warning .callout-icon { color: var(--accent-red); }
        .callout.info {
            background: rgba(86, 182, 194, 0.15);
            border: 1px solid var(--accent-cyan);
        }
        .callout.info .callout-icon { color: var(--accent-cyan); }
        .callout-text {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        /* Mapping Suggestions */
        .suggestions-banner {
            background: rgba(229, 192, 123, 0.15);
            border: 1px solid var(--accent-yellow);
            border-radius: 6px;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .suggestions-banner-icon {
            font-size: 1.3rem;
        }
        .suggestions-banner-text {
            flex: 1;
            color: var(--text-primary);
        }
        .suggestions-banner strong {
            color: var(--accent-yellow);
        }

        .suggestion-expand-btn {
            background: none;
            border: none;
            color: var(--accent-cyan);
            cursor: pointer;
            padding: 2px 8px;
            font-size: 0.85rem;
            text-decoration: underline;
            transition: color 0.2s;
        }
        .suggestion-expand-btn:hover {
            color: var(--accent-blue);
        }

        .suggestions-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            margin-bottom: 10px;
            display: none;
        }
        .suggestions-container.visible {
            display: block;
        }

        .suggestion-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .suggestion-item:last-child {
            margin-bottom: 0;
        }

        .suggestion-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .confidence-badge.high {
            background: rgba(107, 201, 107, 0.2);
            color: var(--accent-green);
        }
        .confidence-badge.medium {
            background: rgba(229, 192, 123, 0.2);
            color: var(--accent-yellow);
        }
        .confidence-badge.low {
            background: rgba(224, 108, 117, 0.2);
            color: var(--accent-red);
        }

        .suggestion-setting-name {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .suggestion-details {
            margin-left: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .suggestion-csp-uri {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--accent-cyan);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .suggestion-reasons {
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .suggestion-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .btn-copy-mapping {
            background: var(--accent-cyan);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-copy-mapping:hover {
            background: var(--accent-blue);
        }

        .btn-view-code {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .btn-view-code:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* Modal for code display */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        .modal-header h3 {
            color: var(--accent-blue);
            margin: 0;
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        .modal-close:hover {
            color: var(--accent-red);
        }
        .code-block {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: pre-wrap;
            overflow-x: auto;
            margin-bottom: 15px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <h1>PolicyLens Viewer</h1>
        <div class="nav-actions">
            <button class="btn btn-secondary" onclick="showView('upload')" id="nav-upload">Upload Files</button>
            <button class="btn btn-secondary" onclick="showView('single')" id="nav-single" disabled>Single View</button>
            <button class="btn btn-secondary" onclick="showView('compare')" id="nav-compare" disabled>Compare</button>
        </div>
    </div>

    <!-- Upload View -->
    <div id="view-upload" class="view active">
        <div class="welcome-panel">
            <h2>Welcome to PolicyLens Viewer</h2>
            <p>This tool helps Windows Engineers plan GPO-to-Intune migration by analyzing policy overlap on Windows devices.</p>
            <ul>
                <li>See all GPO registry policies and MDM settings on a device</li>
                <li>Identify conflicts where GPO and Intune configure the same setting differently</li>
                <li>Find GPO settings ready to migrate (have known Intune equivalents)</li>
                <li>View Intune app assignments and Azure AD group memberships</li>
            </ul>
        </div>
        <input type="file" id="file-input" accept=".json" multiple style="position: absolute; left: -9999px;">
        <div class="drop-zone" id="drop-zone">
            <h2>Drop PolicyLens JSON Files Here</h2>
            <p>or click to select files</p>
            <label for="file-input" class="btn" style="margin-top: 15px; display: inline-block; cursor: pointer;">Browse Files</label>
        </div>

        <div id="loaded-devices">
            <h3 style="margin-bottom: 10px; color: var(--text-secondary);">Loaded Devices</h3>
            <div class="device-cards" id="device-cards">
                <p style="color: var(--text-secondary);">No devices loaded. Drop JSON files above.</p>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button class="btn" onclick="viewSelectedDevice()" id="btn-view-single" disabled>View Selected Device</button>
            <button class="btn" onclick="compareSelectedDevices()" id="btn-compare" disabled>Compare Selected Devices (2)</button>
        </div>
    </div>

    <!-- Single Device View -->
    <div id="view-single" class="view">
        <div id="single-content"></div>
    </div>

    <!-- Compare View -->
    <div id="view-compare" class="view">
        <div id="compare-content"></div>
    </div>

    <div class="report-footer">
        PolicyLens Viewer - View and compare policy exports
    </div>

    <script>
        // Application State
        const AppState = {
            devices: [],
            currentView: 'upload',
            selectedDevices: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initDropZone();
        });

        // File handling
        function initDropZone() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');

            // Click anywhere on drop zone (except the button) opens file picker
            dropZone.addEventListener('click', (e) => {
                if (e.target.tagName !== 'LABEL') {
                    fileInput.click();
                }
            });

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                handleFileDrop(e);
            });

            fileInput.addEventListener('change', handleFileSelect);
        }

        function handleFileDrop(e) {
            const files = e.dataTransfer.files;
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            processFiles(files);
            e.target.value = '';
        }

        function processFiles(files) {
            for (const file of files) {
                if (file.type === 'application/json' || file.name.endsWith('.json')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (validateSchema(data)) {
                                // Check for duplicates
                                const exists = AppState.devices.some(d =>
                                    d.device?.computerName === data.device?.computerName &&
                                    d.exportedAt === data.exportedAt
                                );
                                if (!exists) {
                                    AppState.devices.push(data);
                                    renderDeviceCards();
                                } else {
                                    alert(`Device "${data.device?.computerName || 'Unknown'}" is already loaded.`);
                                }
                            } else {
                                alert(`Invalid schema in file: ${file.name}. Expected schemaVersion 1.0-1.3.`);
                            }
                        } catch (err) {
                            alert(`Error parsing ${file.name}: ${err.message}`);
                        }
                    };
                    reader.readAsText(file);
                }
            }
        }

        function validateSchema(data) {
            // Accept schema versions 1.0 through 1.3
            const validVersions = ["1.0", "1.1", "1.2", "1.3"];
            return data && validVersions.includes(data.schemaVersion);
        }

        function removeDevice(index, e) {
            e.stopPropagation();
            AppState.devices.splice(index, 1);
            AppState.selectedDevices = AppState.selectedDevices.filter(i => i !== index).map(i => i > index ? i - 1 : i);
            renderDeviceCards();
            updateNavButtons();
        }

        function renderDeviceCards() {
            const container = document.getElementById('device-cards');

            if (AppState.devices.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No devices loaded. Drop JSON files above.</p>';
                return;
            }

            container.innerHTML = AppState.devices.map((device, index) => {
                const name = device.device?.computerName || 'Unknown Device';
                const date = device.exportedAt ? formatDate(device.exportedAt) : 'Unknown date';
                const gpoObjectCount = device.gpoData?.TotalGPOCount || 0;
                const gpoSettingsCount = device.gpoData?.RegistryPolicies?.length || 0;
                const mdmCount = device.mdmData?.IntunePolicyCount ?? ((device.mdmData?.DevicePolicies?.length || 0) + (device.mdmData?.UserPolicies?.length || 0));
                const isSelected = AppState.selectedDevices.includes(index);

                return `
                    <div class="device-card ${isSelected ? 'selected' : ''}" onclick="selectDevice(${index})">
                        <span class="remove" onclick="removeDevice(${index}, event)">&times;</span>
                        <div class="name">${escapeHtml(name)}</div>
                        <div class="info">${escapeHtml(date)}</div>
                        <div class="info">${gpoObjectCount} GPOs (${gpoSettingsCount} settings), ${mdmCount} MDM</div>
                    </div>
                `;
            }).join('');

            updateNavButtons();
        }

        function selectDevice(index) {
            const idx = AppState.selectedDevices.indexOf(index);
            if (idx > -1) {
                AppState.selectedDevices.splice(idx, 1);
            } else {
                if (AppState.selectedDevices.length >= 2) {
                    AppState.selectedDevices.shift();
                }
                AppState.selectedDevices.push(index);
            }
            renderDeviceCards();
        }

        function updateNavButtons() {
            const btnViewSingle = document.getElementById('btn-view-single');
            const btnCompare = document.getElementById('btn-compare');
            const navSingle = document.getElementById('nav-single');
            const navCompare = document.getElementById('nav-compare');

            btnViewSingle.disabled = AppState.selectedDevices.length !== 1;
            btnCompare.disabled = AppState.selectedDevices.length !== 2;
            navSingle.disabled = AppState.devices.length === 0;
            navCompare.disabled = AppState.devices.length < 2;
        }

        // View switching
        function showView(viewName) {
            AppState.currentView = viewName;
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');

            document.querySelectorAll('.nav-actions .btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${viewName}`)?.classList.add('active');
        }

        function viewSelectedDevice() {
            if (AppState.selectedDevices.length === 1) {
                const device = AppState.devices[AppState.selectedDevices[0]];
                renderSingleView(device);
                showView('single');
            }
        }

        function compareSelectedDevices() {
            if (AppState.selectedDevices.length === 2) {
                const device1 = AppState.devices[AppState.selectedDevices[0]];
                const device2 = AppState.devices[AppState.selectedDevices[1]];
                renderCompareView(device1, device2);
                showView('compare');
            }
        }

        // Single device rendering
        function renderSingleView(device) {
            // Clear suggestion data from previous render
            suggestionData = {};

            const container = document.getElementById('single-content');
            const name = device.device?.computerName || 'Unknown Device';
            const enrolled = device.mdmData?.IsEnrolled;
            const domainJoined = device.device?.domainJoined;
            const azureJoined = device.device?.azureADJoined;
            const hybridJoined = device.device?.hybridJoined;
            const sccmInstalled = device.sccmData?.IsInstalled;

            // Determine management type
            let managementType = 'Unmanaged';
            let managementClass = 'gray';
            if (hybridJoined || (domainJoined && azureJoined)) {
                managementType = sccmInstalled ? 'Hybrid + Co-Managed' : 'Hybrid Joined';
                managementClass = 'cyan';
            } else if (azureJoined && !domainJoined) {
                managementType = 'Cloud Only';
                managementClass = 'blue';
            } else if (domainJoined && sccmInstalled) {
                managementType = 'On-Prem (SCCM)';
                managementClass = 'magenta';
            } else if (domainJoined) {
                managementType = 'Domain Joined';
                managementClass = 'gray';
            }

            container.innerHTML = `
                <div class="report-header">
                    <h1>${escapeHtml(name)}
                        ${enrolled ? '<span class="badge badge-enrolled">MDM Enrolled</span>' : '<span class="badge badge-not-enrolled">Not Enrolled</span>'}
                        <span class="badge badge-${managementClass}" style="background-color: var(--accent-${managementClass}); color: #1e1e2e;">${managementType}</span>
                    </h1>
                    <div class="subtitle">
                        Exported: ${device.exportedAt ? formatDate(device.exportedAt) : 'Unknown'} |
                        OS: ${escapeHtml(device.device?.osVersion || 'Unknown')}
                    </div>
                </div>
                ${renderSummaryCards(device)}
                ${renderCallouts(device)}

                <div class="category-divider">
                    <div class="category-divider-line"></div>
                    <div class="category-divider-text">Policies Currently Applied to This Device</div>
                    <div class="category-divider-line"></div>
                </div>
                <div class="info-box explanation" style="margin-bottom: 20px;">
                    The sections below show policies and configurations that are <strong>actively applied</strong> on this device right now.
                </div>
                ${renderGPOSection(device)}
                ${renderMDMSection(device)}
                ${renderSCCMSection(device)}

                <div class="category-divider">
                    <div class="category-divider-line"></div>
                    <div class="category-divider-text">Policies & Apps Assigned from Intune</div>
                    <div class="category-divider-line"></div>
                </div>
                <div class="info-box explanation" style="margin-bottom: 20px;">
                    The sections below show what is <strong>assigned</strong> to this device from your Intune tenant (requires -IncludeGraph scan).
                </div>
                ${renderProfilesSection(device)}
                ${renderAppsSection(device)}
                ${renderGroupsSection(device)}

                <div class="category-divider">
                    <div class="category-divider-line"></div>
                    <div class="category-divider-text">Analysis & Insights</div>
                    <div class="category-divider-line"></div>
                </div>
                <div class="info-box explanation" style="margin-bottom: 20px;">
                    Cross-reference analysis to identify conflicts, migration opportunities, and policy overlap between GPO and Intune.
                </div>
                ${renderOverlapSection(device)}
            `;

            initCollapsibles();
        }

        function renderSummaryCards(device) {
            const gpoObjectCount = device.gpoData?.TotalGPOCount || 0;
            const gpoSettingsCount = device.gpoData?.RegistryPolicies?.length || 0;
            const mdmCount = device.mdmData?.IntunePolicyCount ?? ((device.mdmData?.DevicePolicies?.length || 0) + (device.mdmData?.UserPolicies?.length || 0));
            const sccmInstalled = device.sccmData?.IsInstalled || false;
            const sccmVerification = device.sccmVerificationData;
            const hasSCCMVerification = sccmVerification?.enabled;
            const analysis = device.analysis?.Summary || {};
            const matches = analysis.BothConfiguredMatch || 0;
            const conflicts = analysis.ValuesInConflict || 0;
            const migrationReady = analysis.GPOOnlyWithMapping || 0;
            const noMapping = analysis.GPOOnlyNoMapping || 0;

            // Calculate Intune assignment counts
            const graphData = device.graphData || {};
            const groupData = device.groupData || {};
            const appData = device.appData || {};
            const deviceGroupIds = getDeviceGroupIds(groupData);

            const profiles = graphData.Profiles || [];
            const compliance = graphData.CompliancePolicies || [];
            const settingsCatalog = graphData.SettingsCatalog || [];
            const allApps = appData.Apps || [];

            const applicableProfiles = profiles.filter(p => policyAppliesToDevice(p, deviceGroupIds)).length;
            const applicableCompliance = compliance.filter(p => policyAppliesToDevice(p, deviceGroupIds)).length;
            const applicableCatalog = settingsCatalog.filter(p => policyAppliesToDevice(p, deviceGroupIds)).length;
            const applicableApps = allApps.filter(app => appAppliesToDevice(app, deviceGroupIds)).length;
            const hasGraphData = graphData.Available;

            // SCCM verification summary
            let sccmDescription = sccmInstalled ? 'ConfigMgr installed' : 'Not installed';
            if (hasSCCMVerification) {
                const installed = sccmVerification.installedCount || 0;
                const pending = sccmVerification.pendingCount || 0;
                const failed = sccmVerification.failedCount || 0;
                sccmDescription = `${installed} OK, ${pending} pending, ${failed} failed`;
            }

            return `
                <div class="summary-section">
                    <div class="summary-section-header">Policy Sources (Applied on Device)</div>
                    <div class="summary-grid">
                        <div class="summary-card blue" onclick="scrollToSection('section-gpo')" style="cursor:pointer;">
                            <span class="number">${gpoObjectCount}</span>
                            <span class="label">GPOs Applied</span>
                            <span class="description">${gpoSettingsCount} registry settings</span>
                        </div>
                        <div class="summary-card blue" onclick="scrollToSection('section-mdm')" style="cursor:pointer;">
                            <span class="number">${mdmCount}</span>
                            <span class="label">MDM Policies</span>
                            <span class="description">From Intune/MDM</span>
                        </div>
                        <div class="summary-card ${sccmInstalled ? (hasSCCMVerification ? 'cyan' : 'green') : 'gray'} status" onclick="scrollToSection('section-sccm')" style="cursor:pointer;">
                            <span class="number">${sccmInstalled ? (hasSCCMVerification ? 'Verified' : 'Yes') : 'No'}</span>
                            <span class="label">SCCM Client</span>
                            <span class="description">${sccmDescription}</span>
                        </div>
                    </div>
                </div>
                ${hasGraphData ? `
                <div class="summary-section">
                    <div class="summary-section-header">Intune Assignments (from Graph API)</div>
                    <div class="summary-grid-compact">
                        <div class="summary-card-small cyan" onclick="scrollToSection('section-profiles')">
                            <span class="number">${applicableProfiles}</span>
                            <span class="label">Config Profiles</span>
                        </div>
                        <div class="summary-card-small cyan" onclick="scrollToSection('section-profiles')">
                            <span class="number">${applicableCompliance}</span>
                            <span class="label">Compliance</span>
                        </div>
                        <div class="summary-card-small cyan" onclick="scrollToSection('section-profiles')">
                            <span class="number">${applicableCatalog}</span>
                            <span class="label">Settings Catalog</span>
                        </div>
                        <div class="summary-card-small magenta" onclick="scrollToSection('section-apps')">
                            <span class="number">${applicableApps}</span>
                            <span class="label">Apps</span>
                        </div>
                    </div>
                </div>
                ` : ''}
                <div class="summary-section">
                    <div class="summary-section-header">Overlap Analysis</div>
                    <div class="summary-grid-compact">
                        <div class="summary-card-small green" onclick="scrollToSection('section-overlap')">
                            <span class="number">${matches}</span>
                            <span class="label">Matches</span>
                        </div>
                        <div class="summary-card-small red" onclick="scrollToSection('section-overlap')">
                            <span class="number">${conflicts}</span>
                            <span class="label">Conflicts</span>
                        </div>
                        <div class="summary-card-small cyan" onclick="scrollToSection('section-overlap')">
                            <span class="number">${migrationReady}</span>
                            <span class="label">Migration Ready</span>
                        </div>
                        <div class="summary-card-small magenta" onclick="scrollToSection('section-overlap')">
                            <span class="number">${noMapping}</span>
                            <span class="label">No Mapping</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCallouts(device) {
            const analysis = device.analysis?.Summary || {};
            const conflicts = analysis.ValuesInConflict || 0;
            const migrationReady = analysis.GPOOnlyWithMapping || 0;

            let html = '';

            if (conflicts > 0) {
                html += `
                    <div class="callout warning">
                        <span class="callout-icon">âš ï¸</span>
                        <span class="callout-text"><strong>${conflicts} conflict${conflicts > 1 ? 's' : ''} detected</strong> - These settings have different values in GPO vs Intune and need review.</span>
                    </div>
                `;
            }

            if (migrationReady > 0) {
                html += `
                    <div class="callout info">
                        <span class="callout-icon">ðŸ“‹</span>
                        <span class="callout-text"><strong>${migrationReady} setting${migrationReady > 1 ? 's' : ''} ready for migration</strong> - These GPO settings have known Intune equivalents.</span>
                    </div>
                `;
            }

            return html;
        }

        function renderGPOSection(device) {
            const settings = device.gpoData?.RegistryPolicies || [];
            const gpoCount = device.gpoData?.TotalGPOCount || 0;
            const gpoVerification = device.gpoVerificationData;
            const hasVerification = gpoVerification?.enabled;

            // Build verification status summary
            let verificationSummary = '';
            if (hasVerification) {
                const applied = gpoVerification.appliedCount || 0;
                const denied = gpoVerification.deniedCount || 0;
                const disabled = gpoVerification.disabledCount || 0;
                verificationSummary = ` (${applied} Applied, ${denied} Filtered, ${disabled} Disabled)`;
            }

            // Build GPO verification table if data available
            let verificationTableHtml = '';
            if (hasVerification && gpoVerification.verificationStates?.length > 0) {
                const states = gpoVerification.verificationStates;
                verificationTableHtml = `
                    <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">GPO Application Status (${states.length} Linked GPOs)</h3>
                    <div class="info-box info" style="margin-bottom: 10px;">
                        Shows GPOs linked to this device's OU hierarchy in Active Directory and whether they applied successfully.
                    </div>
                    <div class="table-wrapper">
                        <table id="gpo-verification-table">
                            <thead>
                                <tr>
                                    <th>GPO Name</th>
                                    <th>Link Location</th>
                                    <th>Scope</th>
                                    <th>Enforced</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${states.map(s => {
                                    const status = getGPOVerificationStatus(s.GPOGuid, s.GPOName, gpoVerification);
                                    const rowClass = 'status-' + status.cssClass;
                                    const linkLocation = s.LinkLocation ? s.LinkLocation.split(',').slice(0, 2).join(',') : '-';
                                    return `
                                        <tr class="${rowClass}">
                                            <td><strong>${escapeHtml(s.GPOName || s.GPOGuid || '')}</strong></td>
                                            <td style="font-size: 0.8rem;" title="${escapeHtml(s.LinkLocation || '')}">${escapeHtml(linkLocation)}</td>
                                            <td>${escapeHtml(s.Scope || 'Computer')}</td>
                                            <td>${s.Enforced ? '<span class="status-tag conflict">Yes</span>' : '<span style="color: var(--text-secondary);">No</span>'}</td>
                                            <td><span class="status-tag ${status.cssClass}">${escapeHtml(status.label)}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (hasVerification && !gpoVerification.deviceFound) {
                verificationTableHtml = `
                    <div class="info-box warning" style="margin-top: 15px;">
                        <strong>GPO verification unavailable:</strong> Device not found in Active Directory.
                    </div>
                `;
            } else if (hasVerification && !gpoVerification.adReachable) {
                verificationTableHtml = `
                    <div class="info-box warning" style="margin-top: 15px;">
                        <strong>GPO verification unavailable:</strong> Could not connect to Active Directory.
                    </div>
                `;
            }

            if (settings.length === 0 && !hasVerification) {
                return `
                    <div class="section" id="section-gpo">
                        <div class="section-header collapsed">
                            <h2>Group Policy - ${gpoCount} GPOs Applied, 0 Registry Settings</h2>
                            <span class="toggle">&#9660;</span>
                        </div>
                        <div class="section-body hidden">
                            <p style="color: var(--text-secondary);">No GPO registry settings found.</p>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="section" id="section-gpo">
                    <div class="section-header collapsed">
                        <h2>Group Policy - ${gpoCount} GPOs Applied, ${settings.length} Registry Settings${verificationSummary}</h2>
                        <span class="toggle">&#9660;</span>
                    </div>
                    <div class="section-body hidden">
                        <div class="info-box explanation">
                            <strong>What this shows:</strong> Registry-based policies currently applied from Active Directory Group Policy Objects.<br>
                            <strong>Why it matters:</strong> These settings are managed via GPO. When migrating to Intune, you'll need to recreate equivalent policies.
                        </div>
                        ${verificationTableHtml}
                        ${settings.length > 0 ? `
                        <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">Registry Settings (${settings.length})</h3>
                        <div class="filter-bar">
                            <input type="text" id="gpo-search" placeholder="Search GPO settings..." oninput="filterTable('gpo-table', 'gpo-search')">
                        </div>
                        <div class="table-wrapper">
                            <table id="gpo-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Path</th>
                                        <th>Value Name</th>
                                        <th>Value</th>
                                        <th>Scope</th>
                                        <th>Source GPO</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${settings.map(s => `
                                        <tr>
                                            <td>${escapeHtml(s.Category || '')}</td>
                                            <td style="font-size: 0.8rem;">${escapeHtml(s.Path || '')}</td>
                                            <td>${escapeHtml(s.ValueName || '')}</td>
                                            <td>${escapeHtml(formatValue(s.Data))}</td>
                                            <td>${escapeHtml(s.Scope || '')}</td>
                                            <td style="font-size: 0.85rem;">${s.SourceGPO ? `<span class="status-tag mdm-only">${escapeHtml(s.SourceGPO)}</span>` : '<span style="color: var(--text-secondary);">-</span>'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderMDMSection(device) {
            const mdm = device.mdmData || {};
            const enrollments = mdm.Enrollments || [];
            const isEnrolled = mdm.IsEnrolled;
            // Use IntunePolicies (only Intune-configured) as primary, fall back to DevicePolicies for older exports
            const intunePolicies = mdm.IntunePolicies || [];
            const devicePolicies = mdm.DevicePolicies || [];
            const userPolicies = mdm.UserPolicies || [];
            const totalCSPCount = mdm.TotalCSPValueCount || (devicePolicies.length + userPolicies.length);

            // If we have IntunePolicies, use that; otherwise fall back to legacy DevicePolicies
            const hasNewFormat = intunePolicies.length > 0 || mdm.IntunePolicyCount !== undefined;
            const displayPolicies = hasNewFormat ? intunePolicies : [...devicePolicies, ...userPolicies];
            const policyCount = hasNewFormat ? (mdm.IntunePolicyCount || intunePolicies.length) : displayPolicies.length;

            // Calculate sync status
            const lastSyncTime = mdm.LastSyncTime ? new Date(mdm.LastSyncTime) : null;
            const now = new Date();
            const hoursSinceSync = lastSyncTime ? (now - lastSyncTime) / (1000 * 60 * 60) : null;

            let syncStatusHtml = '';
            if (lastSyncTime) {
                const syncTimeStr = lastSyncTime.toLocaleString();
                let syncClass = 'success';
                let syncLabel = 'Recent';
                if (hoursSinceSync > 8) {
                    syncClass = 'error';
                    syncLabel = 'Stale';
                } else if (hoursSinceSync > 4) {
                    syncClass = 'warning';
                    syncLabel = 'Aging';
                }
                const hoursAgo = Math.round(hoursSinceSync);
                syncStatusHtml = `
                    <div class="sync-status" style="margin-top: 10px; padding: 10px; border-radius: 6px; background: var(--card-bg);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="badge badge-${syncClass === 'error' ? 'not-enrolled' : syncClass === 'warning' ? 'warning' : 'enrolled'}">${syncLabel}</span>
                            <span style="color: var(--text-secondary);">Last sync: <strong>${syncTimeStr}</strong> (${hoursAgo}h ago)</span>
                        </div>
                        ${hoursSinceSync > 8 ? '<div class="info-box warning" style="margin-top: 10px;"><strong>Sync may be stale.</strong> Policies assigned in Intune may not have reached this device yet. Try syncing the device manually.</div>' : ''}
                    </div>
                `;
            }

            let enrollmentHtml = '';
            if (isEnrolled && enrollments.length > 0) {
                const enr = enrollments[0];
                enrollmentHtml = `
                    <div class="info-box success">MDM Enrolled</div>
                    <div class="enrollment-grid">
                        ${enr.ProviderId ? `<div class="enrollment-item"><div class="key">Provider</div><div class="value">${escapeHtml(enr.ProviderId)}</div></div>` : ''}
                        ${enr.UPN ? `<div class="enrollment-item"><div class="key">UPN</div><div class="value">${escapeHtml(enr.UPN)}</div></div>` : ''}
                        ${enr.AADTenantId ? `<div class="enrollment-item"><div class="key">Tenant ID</div><div class="value">${escapeHtml(enr.AADTenantId)}</div></div>` : ''}
                        ${enr.EnrollmentId ? `<div class="enrollment-item"><div class="key">Enrollment ID</div><div class="value">${escapeHtml(enr.EnrollmentId)}</div></div>` : ''}
                    </div>
                    ${syncStatusHtml}
                `;
            } else {
                enrollmentHtml = '<div class="info-box warning">Device is not MDM enrolled</div>';
            }

            let policiesHtml = '';
            if (displayPolicies.length > 0) {
                const countLabel = hasNewFormat && totalCSPCount > 0
                    ? `Intune-Configured Policies (${policyCount} of ${totalCSPCount} total CSP values)`
                    : `MDM Policies (${policyCount})`;
                policiesHtml = `
                    <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">${countLabel}</h3>
                    ${hasNewFormat ? `<div class="info-box info" style="margin-bottom: 10px;">Showing only policies explicitly configured by Intune. ${totalCSPCount - policyCount} default/system CSP values are hidden.</div>` : ''}
                    <div class="filter-bar">
                        <input type="text" id="mdm-search" placeholder="Search MDM policies..." oninput="filterTable('mdm-table', 'mdm-search')">
                    </div>
                    <div class="table-wrapper">
                        <table id="mdm-table">
                            <thead>
                                <tr>
                                    <th>Area</th>
                                    <th>Setting</th>
                                    <th>Value</th>
                                    <th>Scope</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${displayPolicies.map(p => `
                                    <tr>
                                        <td>${escapeHtml(p.Area || '')}</td>
                                        <td>${escapeHtml(p.Setting || '')}</td>
                                        <td>${escapeHtml(formatValue(p.Value))}</td>
                                        <td>${escapeHtml(p.Scope || '')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (isEnrolled) {
                policiesHtml = `<div class="info-box info" style="margin-top: 15px;">No Intune-configured policies found on this device.</div>`;
            }

            const enrolledStatus = isEnrolled ? 'Enrolled' : 'Not Enrolled';
            const policyLabel = hasNewFormat ? `${policyCount} Intune Policies Applied` : 'Legacy Format';

            return `
                <div class="section" id="section-mdm">
                    <div class="section-header collapsed">
                        <h2>MDM/Intune - ${enrolledStatus}, ${policyLabel}</h2>
                        <span class="toggle">&#9660;</span>
                    </div>
                    <div class="section-body hidden">
                        <div class="info-box explanation">
                            <strong>What this shows:</strong> Policies explicitly configured by Intune on this device (read from local PolicyManager registry).<br>
                            <strong>Why it matters:</strong> This is what Intune has successfully applied to the device. Compare with "Assigned" policies below to see if everything landed.
                        </div>
                        ${enrollmentHtml}
                        ${policiesHtml}
                    </div>
                </div>
            `;
        }

        // --- SCCM Verification Helper Function ---
        function getSCCMVerificationStatus(deploymentName, deploymentType, sccmVerificationData) {
            if (!sccmVerificationData?.enabled) {
                return { state: 'unknown', label: 'Unknown', cssClass: 'unknown' };
            }

            const state = sccmVerificationData.verificationStates?.find(s =>
                s.DeploymentName === deploymentName && s.DeploymentType === deploymentType
            );

            if (!state) {
                return { state: 'unknown', label: 'Unknown', cssClass: 'unknown' };
            }

            const stateMap = {
                'installed': { state: 'installed', label: 'Installed', cssClass: 'applied' },
                'compliant': { state: 'compliant', label: 'Compliant', cssClass: 'applied' },
                'pending': { state: 'pending', label: 'Pending', cssClass: 'pending' },
                'failed': { state: 'failed', label: 'Failed', cssClass: 'error' },
                'not-applicable': { state: 'not-applicable', label: 'Not Applicable', cssClass: 'unknown' },
                'not-installed': { state: 'not-installed', label: 'Not Installed', cssClass: 'not-applied' },
                'unknown': { state: 'unknown', label: 'Unknown', cssClass: 'unknown' }
            };

            return stateMap[state.Status] || { state: state.Status, label: state.StatusLabel || state.Status, cssClass: 'unknown' };
        }

        function renderSCCMSection(device) {
            const sccm = device.sccmData;
            const sccmVerification = device.sccmVerificationData;

            if (!sccm || !sccm.IsInstalled) {
                return `
                    <div class="section" id="section-sccm">
                        <div class="section-header collapsed">
                            <h2>SCCM/ConfigMgr - Not Installed</h2>
                            <span class="toggle">&#9660;</span>
                        </div>
                        <div class="section-body hidden">
                            <div class="info-box warning">SCCM client not installed on this device</div>
                        </div>
                    </div>
                `;
            }

            const clientInfo = sccm.ClientInfo || {};
            const apps = sccm.Applications || [];
            const baselines = sccm.Baselines || [];
            const updates = sccm.Updates || [];
            const hasVerification = sccmVerification?.enabled;

            let clientHtml = `
                <div class="info-box explanation">
                    <strong>What this shows:</strong> Applications and baselines managed by Configuration Manager (SCCM).<br>
                    <strong>Why it matters:</strong> If migrating away from SCCM, you'll need to move these apps to Intune or another deployment method.
                </div>
                <h3 style="margin-bottom: 10px; color: var(--text-secondary);">Client Information</h3>
                <div class="enrollment-grid">
                    ${clientInfo.ClientVersion ? `<div class="enrollment-item"><div class="key">Client Version</div><div class="value">${escapeHtml(clientInfo.ClientVersion)}</div></div>` : ''}
                    ${clientInfo.SiteCode ? `<div class="enrollment-item"><div class="key">Site Code</div><div class="value">${escapeHtml(clientInfo.SiteCode)}</div></div>` : ''}
                    ${clientInfo.ManagementPoint ? `<div class="enrollment-item"><div class="key">Management Point</div><div class="value">${escapeHtml(clientInfo.ManagementPoint)}</div></div>` : ''}
                    ${clientInfo.ClientId ? `<div class="enrollment-item"><div class="key">Client ID</div><div class="value" style="font-size: 0.8rem;">${escapeHtml(clientInfo.ClientId)}</div></div>` : ''}
                </div>
            `;

            // --- SCCM Deployment Verification Section ---
            let verificationHtml = '';
            if (hasVerification) {
                const verificationStates = sccmVerification.verificationStates || [];
                const collections = sccmVerification.collectionMemberships || [];
                const installedCount = sccmVerification.installedCount || 0;
                const pendingCount = sccmVerification.pendingCount || 0;
                const failedCount = sccmVerification.failedCount || 0;

                // Collection memberships display
                let collectionsHtml = '';
                if (collections.length > 0) {
                    collectionsHtml = `
                        <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">Collection Memberships (${collections.length})</h3>
                        <div class="group-list">
                            ${collections.map(c => `
                                <span class="group-chip">${escapeHtml(c.Name || c.CollectionID)}</span>
                            `).join('')}
                        </div>
                    `;
                }

                // Deployment status table
                let deploymentTableHtml = '';
                if (verificationStates.length > 0) {
                    deploymentTableHtml = `
                        <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">
                            SCCM Deployment Status (${verificationStates.length})
                            <span style="font-size: 0.8rem; font-weight: normal; color: var(--text-secondary); margin-left: 10px;">
                                <span style="color: var(--accent-green);">${installedCount} installed</span>,
                                <span style="color: var(--accent-yellow);">${pendingCount} pending</span>,
                                <span style="color: var(--accent-red);">${failedCount} failed</span>
                            </span>
                        </h3>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Deployment Name</th>
                                        <th>Type</th>
                                        <th>Collection</th>
                                        <th>Intent</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${verificationStates.map(state => {
                                        const statusClass = {
                                            'installed': 'applied',
                                            'compliant': 'applied',
                                            'pending': 'pending',
                                            'failed': 'error',
                                            'not-installed': 'not-applied',
                                            'not-applicable': 'unknown'
                                        }[state.Status] || 'unknown';
                                        const intentClass = state.Intent === 'Required' ? 'required' : 'available';
                                        return `
                                            <tr class="status-${statusClass}">
                                                <td><strong>${escapeHtml(state.DeploymentName || '')}</strong></td>
                                                <td>${escapeHtml(state.DeploymentType || '')}</td>
                                                <td style="font-size: 0.85rem;">${escapeHtml(state.CollectionName || '')}</td>
                                                <td><span class="app-intent ${intentClass}">${escapeHtml(state.Intent || '')}</span></td>
                                                <td><span class="status-tag ${statusClass}">${escapeHtml(state.StatusLabel || state.Status || '')}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                verificationHtml = `
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                        <h3 style="margin-bottom: 10px; color: var(--accent-cyan);">
                            <span style="margin-right: 8px;">&#9989;</span>Deployment Verification
                        </h3>
                        <div class="info-box info" style="margin-bottom: 15px;">
                            Verified against site server: <strong>${escapeHtml(sccmVerification.siteServer || 'Unknown')}</strong>
                            (Site Code: ${escapeHtml(sccmVerification.siteCode || 'Unknown')})
                        </div>
                        ${collectionsHtml}
                        ${deploymentTableHtml}
                    </div>
                `;
            }

            let appsHtml = '';
            if (apps.length > 0) {
                appsHtml = `
                    <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">SCCM Applications (${apps.length})</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Publisher</th>
                                    <th>Version</th>
                                    <th>Install State</th>
                                    <th>Required</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${apps.map(app => `
                                    <tr>
                                        <td>${escapeHtml(app.Name || '')}</td>
                                        <td>${escapeHtml(app.Publisher || '')}</td>
                                        <td>${escapeHtml(app.Version || '')}</td>
                                        <td><span class="status-tag ${app.InstallState === 'Installed' ? 'both-match' : 'no-mapping'}">${escapeHtml(app.InstallState || '')}</span></td>
                                        <td>${app.IsRequired ? 'Yes' : 'No'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            let baselinesHtml = '';
            if (baselines.length > 0) {
                baselinesHtml = `
                    <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">Compliance Baselines (${baselines.length})</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Version</th>
                                    <th>Compliance State</th>
                                    <th>Last Evaluated</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${baselines.map(b => {
                                    const stateClass = b.ComplianceState === 'Compliant' ? 'both-match' :
                                                      b.ComplianceState === 'Non-Compliant' ? 'conflict' : 'no-mapping';
                                    return `
                                        <tr>
                                            <td>${escapeHtml(b.Name || '')}</td>
                                            <td>${escapeHtml(b.Version || '')}</td>
                                            <td><span class="status-tag ${stateClass}">${escapeHtml(b.ComplianceState || '')}</span></td>
                                            <td>${b.LastEvaluated ? new Date(b.LastEvaluated).toLocaleString() : '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            let updatesHtml = '';
            if (updates.length > 0) {
                const requiredUpdates = updates.filter(u => u.IsRequired);
                updatesHtml = `
                    <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">Software Updates (${updates.length} total, ${requiredUpdates.length} required)</h3>
                    <div class="table-wrapper" style="max-height: 300px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Article ID</th>
                                    <th>Name</th>
                                    <th>State</th>
                                    <th>Required</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${updates.slice(0, 50).map(u => `
                                    <tr>
                                        <td>${escapeHtml(u.ArticleID || '')}</td>
                                        <td style="font-size: 0.85rem;">${escapeHtml(u.Name || '')}</td>
                                        <td>${escapeHtml(u.EvaluationState || '')}</td>
                                        <td>${u.IsRequired ? 'Yes' : 'No'}</td>
                                    </tr>
                                `).join('')}
                                ${updates.length > 50 ? `<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">... and ${updates.length - 50} more updates</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Build section header with verification summary if available
            let headerText = `SCCM/ConfigMgr - ${apps.length} Apps, ${baselines.length} Baselines, ${updates.length} Updates`;
            if (hasVerification) {
                const installedCount = sccmVerification.installedCount || 0;
                const pendingCount = sccmVerification.pendingCount || 0;
                const failedCount = sccmVerification.failedCount || 0;
                headerText += ` | Verified: ${installedCount} installed, ${pendingCount} pending, ${failedCount} failed`;
            }

            return `
                <div class="section" id="section-sccm">
                    <div class="section-header collapsed">
                        <h2>${headerText}</h2>
                        <span class="toggle">&#9660;</span>
                    </div>
                    <div class="section-body hidden">
                        ${clientHtml}
                        ${verificationHtml}
                        ${appsHtml}
                        ${baselinesHtml}
                        ${updatesHtml}
                    </div>
                </div>
            `;
        }

        function renderOverlapSection(device) {
            const overlap = device.analysis?.DetailedResults || [];
            const mappingSuggestions = device.mappingSuggestions || [];

            if (overlap.length === 0) {
                return `
                    <div class="section" id="section-overlap">
                        <div class="section-header collapsed">
                            <h2>GPO vs MDM Overlap Analysis - No Data</h2>
                            <span class="toggle">&#9660;</span>
                        </div>
                        <div class="section-body hidden">
                            <p style="color: var(--text-secondary);">No overlap analysis data available.</p>
                        </div>
                    </div>
                `;
            }

            // Build suggestions lookup by GPO path+valuename
            const suggestionsMap = new Map();
            mappingSuggestions.forEach(s => {
                const key = `${s.GPOPath}|${s.GPOValueName}`;
                if (!suggestionsMap.has(key)) {
                    suggestionsMap.set(key, []);
                }
                suggestionsMap.get(key).push(...(s.Matches || []));
            });

            // Count high confidence suggestions
            const highConfidenceSuggestions = mappingSuggestions.filter(s =>
                (s.Matches || []).some(m => m.Confidence === 'High')
            ).length;

            // Build suggestions banner
            const suggestionsBanner = mappingSuggestions.length > 0 ? `
                <div class="suggestions-banner">
                    <span class="suggestions-banner-icon">ðŸ’¡</span>
                    <div class="suggestions-banner-text">
                        <strong>${highConfidenceSuggestions} high-confidence</strong> mapping suggestions found for unmapped GPO settings.
                        ${mappingSuggestions.length > highConfidenceSuggestions ? ` (${mappingSuggestions.length - highConfidenceSuggestions} additional medium/low confidence)` : ''}
                    </div>
                </div>
            ` : '';

            // Calculate summary counts for title
            const summary = device.analysis?.Summary || {};
            const conflicts = summary.ValuesInConflict || 0;
            const matches = summary.BothConfiguredMatch || 0;
            const migrationReady = summary.GPOOnlyWithMapping || 0;

            return `
                <div class="section" id="section-overlap">
                    <div class="section-header collapsed">
                        <h2>GPO vs MDM Overlap Analysis - ${overlap.length} Settings (${matches} Match, ${conflicts} Conflicts, ${migrationReady} Migration Ready)</h2>
                        <span class="toggle">&#9660;</span>
                    </div>
                    <div class="section-body hidden">
                        <div class="info-box explanation">
                            <strong>What this shows:</strong> Compares each GPO registry setting against Intune/MDM to identify overlaps and conflicts.<br>
                            <strong>Why it matters:</strong> Find settings configured in both places (conflicts), or GPO settings ready to migrate to Intune.
                        </div>
                        ${suggestionsBanner}
                        <div class="legend-box">
                            <div class="legend-item">
                                <span class="legend-color match"></span>
                                <span><span class="legend-label">Match</span> <span class="legend-desc">- Same value in both</span></span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color conflict"></span>
                                <span><span class="legend-label">Conflict</span> <span class="legend-desc">- Different values, needs review</span></span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color migration"></span>
                                <span><span class="legend-label">Migration Ready</span> <span class="legend-desc">- Can migrate to Intune</span></span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color nomapping"></span>
                                <span><span class="legend-label">No Mapping</span> <span class="legend-desc">- No Intune equivalent</span></span>
                            </div>
                        </div>
                        <div class="filter-bar">
                            <input type="text" id="overlap-search" placeholder="Search..." oninput="filterOverlapTable()">
                            <select id="overlap-status-filter" onchange="filterOverlapTable()">
                                <option value="">All Statuses</option>
                                <option value="BothConfigured">Both Configured</option>
                                <option value="GPOOnly_MappingExists">Migration Ready</option>
                                <option value="GPOOnly_NoMapping">No MDM Mapping</option>
                            </select>
                        </div>
                        <div class="table-wrapper">
                            <table id="overlap-table">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Category</th>
                                        <th>Setting</th>
                                        <th>GPO Value</th>
                                        <th>MDM Setting</th>
                                        <th>MDM Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${overlap.map((o, idx) => {
                                        let rowClass = '';
                                        let statusClass = '';
                                        let statusText = '';

                                        if (o.Status === 'BothConfigured') {
                                            if (o.ValuesMatch) {
                                                rowClass = 'status-both-match';
                                                statusClass = 'both-match';
                                                statusText = 'Match';
                                            } else {
                                                rowClass = 'status-both-conflict';
                                                statusClass = 'conflict';
                                                statusText = 'Conflict';
                                            }
                                        } else if (o.Status === 'GPOOnly_MappingExists') {
                                            rowClass = 'status-gpo-mapping';
                                            statusClass = 'migration-ready';
                                            statusText = 'Migration Ready';
                                        } else if (o.Status === 'GPOOnly_NoMapping') {
                                            rowClass = 'status-gpo-nomapping';
                                            statusClass = 'no-mapping';

                                            // Check for suggestions
                                            const suggestionKey = `${o.GPOPath}|${o.GPOValueName}`;
                                            const suggestions = suggestionsMap.get(suggestionKey) || [];

                                            if (suggestions.length > 0) {
                                                statusText = `No Mapping (${suggestions.length} suggestion${suggestions.length > 1 ? 's' : ''})`;
                                            } else {
                                                statusText = 'No Mapping';
                                            }
                                        }

                                        const mdmSetting = o.MDMArea && o.MDMSetting ? `${o.MDMArea}/${o.MDMSetting}` : '-';

                                        // Check for suggestions for this setting
                                        const suggestionKey = `${o.GPOPath}|${o.GPOValueName}`;
                                        const suggestions = suggestionsMap.get(suggestionKey) || [];
                                        const suggestionContent = suggestions.length > 0 ? renderSuggestions(o, suggestions, idx) : '';

                                        return `
                                            <tr class="${rowClass}" data-status="${o.Status}">
                                                <td><span class="status-tag ${statusClass}">${statusText}</span></td>
                                                <td>${escapeHtml(o.Category || '-')}</td>
                                                <td>
                                                    ${escapeHtml(o.GPOValueName || '-')}
                                                    ${suggestions.length > 0 ? `<br><button class="suggestion-expand-btn" onclick="toggleSuggestions('suggestion-${idx}', event)">View Suggestions</button>` : ''}
                                                </td>
                                                <td>${escapeHtml(formatValue(o.GPOValue))}</td>
                                                <td>${escapeHtml(mdmSetting)}</td>
                                                <td>${escapeHtml(formatValue(o.MDMValue))}</td>
                                            </tr>
                                            ${suggestionContent}
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAppsSection(device) {
            const appData = device.appData;
            if (!appData?.Available) {
                return '';
            }

            const groupData = device.groupData;
            const deviceGroupIds = getDeviceGroupIds(groupData);
            const allApps = appData.AssignedApps || [];
            const totalAppsInTenant = appData.Apps?.length || 0;
            const localApps = appData.LocalApps || [];
            const hasLocalApps = localApps.length > 0;

            // Filter apps to only those assigned to this device
            const applicableApps = allApps.filter(app => appAppliesToDevice(app, deviceGroupIds));

            const hasGroupData = groupData?.Available && groupData?.DeviceFound && deviceGroupIds.length > 0;

            // Separate by intent
            const requiredApps = applicableApps.filter(app =>
                (app.Assignments || []).some(a =>
                    a.Intent === 'Required' && assignmentAppliesToDevice(a, deviceGroupIds)
                )
            );
            const availableApps = applicableApps.filter(app =>
                (app.Assignments || []).some(a =>
                    a.Intent === 'Available' && assignmentAppliesToDevice(a, deviceGroupIds)
                ) && !requiredApps.includes(app)
            );

            if (applicableApps.length === 0 && hasGroupData) {
                return `
                    <div class="section" id="section-apps">
                        <div class="section-header collapsed">
                            <h2>Intune Apps Assigned to Device - 0 of ${allApps.length} Apps</h2>
                            <span class="toggle">&#9660;</span>
                        </div>
                        <div class="section-body hidden">
                            <div class="info-box info">
                                No Intune apps are assigned to this device or its ${deviceGroupIds.length} groups.
                                (${totalAppsInTenant} apps exist in tenant, ${allApps.length} have assignments)
                            </div>
                        </div>
                    </div>
                `;
            }

            // Build info message
            let infoMessage = '';
            if (!hasGroupData) {
                // No group data - we can only show "All Devices" / "All Users" apps
                if (applicableApps.length > 0) {
                    infoMessage = `
                        <div class="info-box warning">
                            Group membership data not available - showing only apps assigned to "All Devices" or "All Users".
                            (${applicableApps.length} of ${allApps.length} assigned apps)
                        </div>
                    `;
                } else {
                    infoMessage = `
                        <div class="info-box warning">
                            Group membership data not available. No apps assigned to "All Devices" or "All Users" found.
                            Run with <code>-IncludeGraph</code> to see group-targeted apps.
                        </div>
                    `;
                }
            } else {
                infoMessage = `
                    <div class="info-box explanation">
                        Showing <strong>${applicableApps.length} of ${allApps.length}</strong> assigned apps that apply to this device.
                        (${totalAppsInTenant} total apps in tenant)
                    </div>
                `;
            }

            // Helper to render app table
            const renderAppTable = (apps, title, titleColor) => {
                if (apps.length === 0) return '';
                const statusHeader = hasLocalApps ? '<th>Install Status</th>' : '';
                return `
                    <h3 style="margin: 15px 0 10px; color: ${titleColor};">${title} (${apps.length})</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Publisher</th>
                                    <th>Assigned Via</th>
                                    ${statusHeader}
                                </tr>
                            </thead>
                            <tbody>
                                ${apps.map(app => {
                                    const assignmentReason = getAppAssignmentReason(app, deviceGroupIds, groupData);
                                    const installStatus = hasLocalApps ? getAppInstallationStatus(app.Id, localApps) : null;
                                    const statusCell = hasLocalApps ? `<td>${renderVerificationStatusTag(installStatus)}</td>` : '';
                                    const rowClass = hasLocalApps && installStatus ? `status-${installStatus.cssClass}` : '';
                                    return `
                                        <tr class="${rowClass}">
                                            <td><strong>${escapeHtml(app.DisplayName || 'Unknown App')}</strong></td>
                                            <td style="font-size: 0.85rem;">${escapeHtml(app.AppType || '-')}</td>
                                            <td style="font-size: 0.85rem;">${escapeHtml(app.Publisher || '-')}</td>
                                            <td>${assignmentReason}</td>
                                            ${statusCell}
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            return `
                <div class="section" id="section-apps">
                    <div class="section-header collapsed">
                        <h2>Intune Apps Assigned to Device - ${applicableApps.length} of ${allApps.length} Apps (${requiredApps.length} Required, ${availableApps.length} Available)</h2>
                        <span class="toggle">&#9660;</span>
                    </div>
                    <div class="section-body hidden">
                        <div class="info-box explanation">
                            <strong>What this shows:</strong> Applications assigned to this device from Intune (Required or Available).<br>
                            <strong>Why it matters:</strong> Shows what apps users should be able to install, or what apps are required on this device.
                        </div>
                        ${infoMessage}
                        ${renderAppTable(requiredApps, 'Required Apps', 'var(--accent-yellow)')}
                        ${renderAppTable(availableApps, 'Available Apps', 'var(--accent-green)')}
                        ${!hasGroupData && applicableApps.length > 0 ? renderAppTable(applicableApps, 'Apps', 'var(--text-secondary)') : ''}
                    </div>
                </div>
            `;
        }

        // Get assignment reason for an app (similar to getAssignmentReason for policies)
        function getAppAssignmentReason(app, deviceGroupIds, groupData) {
            const applicableAssignments = (app.Assignments || []).filter(a =>
                assignmentAppliesToDevice(a, deviceGroupIds)
            );

            if (applicableAssignments.length === 0) {
                return '<span class="status-tag">Unknown</span>';
            }

            return applicableAssignments.map(a => {
                if (a.TargetType === 'All Devices') {
                    return '<span class="status-tag both-match">All Devices</span>';
                } else if (a.TargetType === 'All Users') {
                    return '<span class="status-tag migration-ready">All Users</span>';
                } else if (a.GroupId && groupData?.Groups) {
                    const group = groupData.Groups.find(g => g.ObjectId === a.GroupId);
                    const groupName = group?.DisplayName || 'Group';
                    return `<span class="status-tag mdm-only">${escapeHtml(groupName)}</span>`;
                } else {
                    return `<span class="status-tag">${escapeHtml(a.TargetType || 'Unknown')}</span>`;
                }
            }).join(' ');
        }

        // Check if an app applies to the device
        function appAppliesToDevice(app, deviceGroupIds) {
            const assignments = app.Assignments || [];
            return assignments.some(a => assignmentAppliesToDevice(a, deviceGroupIds));
        }

        // Check if a single assignment applies to the device
        function assignmentAppliesToDevice(assignment, deviceGroupIds) {
            const targetType = assignment.TargetType || '';
            const groupId = assignment.GroupId;

            // "All Devices" or "All Users" applies to everyone
            if (targetType === 'All Devices' || targetType === 'All Users') {
                return true;
            }

            // Group-based assignment - check if device is in that group
            if (targetType.startsWith('Group:') && groupId && deviceGroupIds.includes(groupId)) {
                return true;
            }

            return false;
        }

        // Render a single app card
        function renderAppCard(app, deviceGroupIds, groupData) {
            const applicableAssignments = (app.Assignments || []).filter(a =>
                assignmentAppliesToDevice(a, deviceGroupIds)
            );

            const assignmentBadges = applicableAssignments.map(a => {
                const intentClass = a.Intent?.toLowerCase() === 'required' ? 'required' : 'available';
                let targetLabel = '';

                if (a.TargetType === 'All Devices') {
                    targetLabel = '<span class="status-tag both-match">All Devices</span>';
                } else if (a.TargetType === 'All Users') {
                    targetLabel = '<span class="status-tag migration-ready">All Users</span>';
                } else if (a.GroupId && groupData?.Groups) {
                    const group = groupData.Groups.find(g => g.ObjectId === a.GroupId);
                    const groupName = group?.DisplayName || 'Group';
                    targetLabel = `<span class="status-tag mdm-only">${escapeHtml(groupName)}</span>`;
                } else {
                    targetLabel = `<span class="status-tag">${escapeHtml(a.TargetType || '')}</span>`;
                }

                return `<span class="app-intent ${intentClass}">${escapeHtml(a.Intent || '')}</span> ${targetLabel}`;
            }).join(' ');

            return `
                <div class="app-card">
                    <div class="app-name">${escapeHtml(app.DisplayName || 'Unknown App')}</div>
                    <div class="app-type">${escapeHtml(app.AppType || '')} ${app.Publisher ? '- ' + escapeHtml(app.Publisher) : ''}</div>
                    <div style="margin-top: 6px;">${assignmentBadges}</div>
                </div>
            `;
        }

        function renderGroupsSection(device) {
            const groupData = device.groupData;
            if (!groupData?.Available || !groupData?.DeviceFound || !groupData?.Groups?.length) {
                return '';
            }

            const groups = groupData.Groups;
            const deviceInfo = groupData.Device;

            // Separate groups by type
            const dynamicGroups = groups.filter(g => g.GroupType === 'Dynamic');
            const assignedGroups = groups.filter(g => g.GroupType !== 'Dynamic');

            const renderGroupChips = (groupList, typeClass) => {
                if (!groupList.length) return '<span style="color: var(--text-secondary); font-style: italic;">None</span>';
                return groupList.map(g =>
                    `<span class="group-chip ${typeClass}" title="${escapeHtml(g.Description || 'No description')}">${escapeHtml(g.DisplayName || 'Unknown Group')}</span>`
                ).join('');
            };

            return `
                <div class="section" id="section-groups">
                    <div class="section-header collapsed">
                        <h2>Azure AD Group Memberships - ${groups.length} Groups (${dynamicGroups.length} Dynamic, ${assignedGroups.length} Assigned)</h2>
                        <span class="toggle">&#9660;</span>
                    </div>
                    <div class="section-body hidden">
                        <div class="info-box explanation">
                            <strong>What this shows:</strong> Azure AD groups this device is a member of (Dynamic and Assigned).<br>
                            <strong>Why it matters:</strong> Group memberships determine which Intune policies and apps are assigned to this device.
                        </div>
                        ${deviceInfo ? `
                            <div class="enrollment-grid">
                                <div class="enrollment-item"><div class="key">Display Name</div><div class="value">${escapeHtml(deviceInfo.DisplayName || '-')}</div></div>
                                <div class="enrollment-item"><div class="key">Device ID</div><div class="value">${escapeHtml(deviceInfo.DeviceId || '-')}</div></div>
                                <div class="enrollment-item"><div class="key">OS</div><div class="value">${escapeHtml(deviceInfo.OperatingSystem || '')} ${escapeHtml(deviceInfo.OSVersion || '')}</div></div>
                                <div class="enrollment-item"><div class="key">Trust Type</div><div class="value">${escapeHtml(deviceInfo.TrustType || '-')}</div></div>
                                <div class="enrollment-item"><div class="key">Managed</div><div class="value">${deviceInfo.IsManaged || '-'}</div></div>
                                <div class="enrollment-item"><div class="key">Compliant</div><div class="value">${deviceInfo.IsCompliant || '-'}</div></div>
                            </div>
                            <hr style="border-color: var(--border-color); margin: 15px 0;">
                        ` : ''}

                        <div class="group-category">
                            <h3 style="margin-bottom: 10px; font-size: 1rem; color: var(--cyan);">Dynamic Memberships (${dynamicGroups.length})</h3>
                            <div class="group-list">
                                ${renderGroupChips(dynamicGroups, 'dynamic')}
                            </div>
                        </div>

                        <div class="group-category" style="margin-top: 20px;">
                            <h3 style="margin-bottom: 10px; font-size: 1rem; color: var(--blue);">Assigned Memberships (${assignedGroups.length})</h3>
                            <div class="group-list">
                                ${renderGroupChips(assignedGroups, 'assigned')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- GPO Verification Helper Functions ---

        function getGPOVerificationStatus(gpoGuid, gpoName, gpoVerificationData) {
            // If no verification data, return unknown
            if (!gpoVerificationData?.enabled || !gpoVerificationData?.verificationStates) {
                return { state: 'unknown', label: 'Unknown', cssClass: 'unknown' };
            }

            // Try to match by GPO GUID or name
            const normalizedGuid = gpoGuid ? gpoGuid.toUpperCase() : '';
            const normalizedName = gpoName ? gpoName.toLowerCase() : '';

            const state = gpoVerificationData.verificationStates.find(s =>
                (s.GPOGuid && s.GPOGuid.toUpperCase() === normalizedGuid) ||
                (s.GPOName && normalizedName && s.GPOName.toLowerCase() === normalizedName)
            );

            if (!state) {
                return { state: 'unknown', label: 'Unknown', cssClass: 'unknown' };
            }

            const stateMap = {
                'applied': { state: 'applied', label: 'Applied', cssClass: 'applied' },
                'denied': { state: 'denied', label: 'Security Filtered', cssClass: 'not-applied' },
                'not-applied': { state: 'not-applied', label: 'Not Applicable', cssClass: 'unknown' },
                'disabled': { state: 'disabled', label: 'Link Disabled', cssClass: 'pending' }
            };

            return stateMap[state.Status] || { state: state.Status, label: state.StatusLabel || state.Status, cssClass: 'unknown' };
        }

        // --- Deployment Verification Helper Functions ---

        function getProfileVerificationStatus(profileId, profileName, verificationData) {
            // If no verification data, return unknown
            if (!verificationData?.enabled || !verificationData?.profileStates) {
                return { state: 'unknown', label: 'Unknown', cssClass: 'unknown' };
            }

            // Try to match by profile ID or name
            const state = verificationData.profileStates.find(s =>
                s.ProfileId === profileId ||
                (s.ProfileName && profileName && s.ProfileName.toLowerCase() === profileName.toLowerCase())
            );

            if (!state) {
                return { state: 'not-applied', label: 'Not Applied', cssClass: 'not-applied' };
            }

            const stateMap = {
                'applied': { state: 'applied', label: 'Applied', cssClass: 'applied' },
                'pending': { state: 'pending', label: 'Pending', cssClass: 'pending' },
                'error': { state: 'error', label: 'Error', cssClass: 'error' },
                'notApplicable': { state: 'notApplicable', label: 'N/A', cssClass: 'unknown' },
                'unknown': { state: 'unknown', label: 'Unknown', cssClass: 'unknown' }
            };

            return stateMap[state.State] || { state: state.State, label: state.State, cssClass: 'unknown' };
        }

        function getComplianceVerificationStatus(policyId, policyName, verificationData) {
            // If no verification data, return unknown
            if (!verificationData?.enabled || !verificationData?.complianceStates) {
                return { state: 'unknown', label: 'Unknown', cssClass: 'unknown' };
            }

            // Try to match by policy ID or name
            const state = verificationData.complianceStates.find(s =>
                s.PolicyId === policyId ||
                (s.PolicyName && policyName && s.PolicyName.toLowerCase() === policyName.toLowerCase())
            );

            if (!state) {
                return { state: 'not-applied', label: 'Not Applied', cssClass: 'not-applied' };
            }

            const stateMap = {
                'applied': { state: 'applied', label: 'Applied', cssClass: 'applied' },
                'pending': { state: 'pending', label: 'Pending', cssClass: 'pending' },
                'error': { state: 'error', label: 'Error', cssClass: 'error' },
                'notApplicable': { state: 'notApplicable', label: 'N/A', cssClass: 'unknown' },
                'unknown': { state: 'unknown', label: 'Unknown', cssClass: 'unknown' }
            };

            return stateMap[state.State] || { state: state.State, label: state.State, cssClass: 'unknown' };
        }

        function getAppInstallationStatus(appId, localApps) {
            // Check LocalApps array for matching app
            if (!localApps || localApps.length === 0) {
                return { state: 'unknown', label: 'Unknown', cssClass: 'unknown' };
            }

            const localApp = localApps.find(la => la.AppId === appId);
            if (!localApp) {
                return { state: 'not-installed', label: 'Not Installed', cssClass: 'not-installed' };
            }

            // Use the InstallState property if available, otherwise derive from Result
            if (localApp.InstallState) {
                const stateMap = {
                    'Installed': { state: 'installed', label: 'Installed', cssClass: 'installed' },
                    'Pending': { state: 'pending', label: 'Pending', cssClass: 'pending' },
                    'Failed': { state: 'failed', label: 'Failed', cssClass: 'error' },
                    'Unknown': { state: 'unknown', label: 'Unknown', cssClass: 'unknown' }
                };
                return stateMap[localApp.InstallState] || { state: 'unknown', label: localApp.InstallState, cssClass: 'unknown' };
            }

            // Fallback to Result code interpretation
            if (localApp.Result === 1) {
                return { state: 'installed', label: 'Installed', cssClass: 'installed' };
            } else if (localApp.Result === 0) {
                return { state: 'pending', label: 'Pending', cssClass: 'pending' };
            } else {
                return { state: 'failed', label: 'Failed', cssClass: 'error' };
            }
        }

        function renderVerificationStatusTag(status) {
            return `<span class="status-tag ${status.cssClass}">${escapeHtml(status.label)}</span>`;
        }

        function renderProfilesSection(device) {
            const graphData = device.graphData;
            if (!graphData?.Available) {
                return '';
            }

            const groupData = device.groupData;
            const deviceGroupIds = getDeviceGroupIds(groupData);
            const verificationData = device.verificationData;
            const hasVerification = verificationData?.enabled;

            const profiles = graphData.Profiles || [];
            const compliance = graphData.CompliancePolicies || [];
            const settingsCatalog = graphData.SettingsCatalog || [];
            const totalCount = profiles.length + compliance.length + settingsCatalog.length;

            if (totalCount === 0) {
                return '';
            }

            // Filter to only policies that apply to this device
            const applicableProfiles = profiles.filter(p => policyAppliesToDevice(p, deviceGroupIds));
            const applicableCompliance = compliance.filter(p => policyAppliesToDevice(p, deviceGroupIds));
            const applicableCatalog = settingsCatalog.filter(p => policyAppliesToDevice(p, deviceGroupIds));
            const applicableCount = applicableProfiles.length + applicableCompliance.length + applicableCatalog.length;

            // Check if we have group data to filter
            const hasGroupData = groupData?.Available && groupData?.DeviceFound && deviceGroupIds.length > 0;

            let profilesHtml = '';
            if (applicableProfiles.length > 0) {
                const statusHeader = hasVerification ? '<th>Status</th>' : '';
                profilesHtml = `
                    <h3 style="margin: 15px 0 10px; color: var(--text-secondary);">Device Configuration Profiles (${applicableProfiles.length})</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Assigned Via</th>
                                    ${statusHeader}
                                    <th>Last Modified</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${applicableProfiles.map(p => {
                                    const profileType = (p.OdataType || '').replace('#microsoft.graph.', '').replace(/([A-Z])/g, ' $1').trim();
                                    const assignmentReason = getAssignmentReason(p, deviceGroupIds, groupData);
                                    const verificationStatus = hasVerification ? getProfileVerificationStatus(p.Id, p.DisplayName, verificationData) : null;
                                    const statusCell = hasVerification ? `<td>${renderVerificationStatusTag(verificationStatus)}</td>` : '';
                                    const rowClass = hasVerification ? `status-${verificationStatus.cssClass}` : '';
                                    return `
                                        <tr class="${rowClass}">
                                            <td><strong>${escapeHtml(p.DisplayName || '')}</strong></td>
                                            <td style="font-size: 0.85rem;">${escapeHtml(profileType)}</td>
                                            <td>${assignmentReason}</td>
                                            ${statusCell}
                                            <td>${p.LastModified ? new Date(p.LastModified).toLocaleDateString() : '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            let complianceHtml = '';
            if (applicableCompliance.length > 0) {
                const statusHeader = hasVerification ? '<th>Status</th>' : '';
                complianceHtml = `
                    <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">Compliance Policies (${applicableCompliance.length})</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Assigned Via</th>
                                    ${statusHeader}
                                </tr>
                            </thead>
                            <tbody>
                                ${applicableCompliance.map(p => {
                                    const policyType = (p.OdataType || '').replace('#microsoft.graph.', '').replace(/([A-Z])/g, ' $1').trim();
                                    const assignmentReason = getAssignmentReason(p, deviceGroupIds, groupData);
                                    const verificationStatus = hasVerification ? getComplianceVerificationStatus(p.Id, p.DisplayName, verificationData) : null;
                                    const statusCell = hasVerification ? `<td>${renderVerificationStatusTag(verificationStatus)}</td>` : '';
                                    const rowClass = hasVerification ? `status-${verificationStatus.cssClass}` : '';
                                    return `
                                        <tr class="${rowClass}">
                                            <td><strong>${escapeHtml(p.DisplayName || '')}</strong></td>
                                            <td style="font-size: 0.85rem;">${escapeHtml(policyType)}</td>
                                            <td>${assignmentReason}</td>
                                            ${statusCell}
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            let catalogHtml = '';
            if (applicableCatalog.length > 0) {
                const statusHeader = hasVerification ? '<th>Status</th>' : '';
                catalogHtml = `
                    <h3 style="margin: 20px 0 10px; color: var(--text-secondary);">Settings Catalog Policies (${applicableCatalog.length})</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Platform</th>
                                    <th>Technologies</th>
                                    <th>Assigned Via</th>
                                    ${statusHeader}
                                </tr>
                            </thead>
                            <tbody>
                                ${applicableCatalog.map(p => {
                                    const assignmentReason = getAssignmentReason(p, deviceGroupIds, groupData);
                                    const verificationStatus = hasVerification ? getProfileVerificationStatus(p.Id, p.Name, verificationData) : null;
                                    const statusCell = hasVerification ? `<td>${renderVerificationStatusTag(verificationStatus)}</td>` : '';
                                    const rowClass = hasVerification ? `status-${verificationStatus.cssClass}` : '';
                                    return `
                                        <tr class="${rowClass}">
                                            <td><strong>${escapeHtml(p.Name || '')}</strong></td>
                                            <td>${escapeHtml(p.Platforms || '-')}</td>
                                            <td>${escapeHtml(p.Technologies || '-')}</td>
                                            <td>${assignmentReason}</td>
                                            ${statusCell}
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Build info message based on filtering status
            let infoMessage = '';
            if (!hasGroupData) {
                // No group data - we can only show "All Devices" / "All Users" policies
                if (applicableCount > 0) {
                    infoMessage = `
                        <div class="info-box warning">
                            Group membership data not available - showing only policies assigned to "All Devices" or "All Users".
                            (${applicableCount} of ${totalCount} policies)
                        </div>
                    `;
                } else {
                    infoMessage = `
                        <div class="info-box warning">
                            Group membership data not available. No policies assigned to "All Devices" or "All Users" found.
                            Run with <code>-IncludeGraph</code> to see group-targeted policies.
                        </div>
                    `;
                }
            } else if (applicableCount === 0) {
                infoMessage = `
                    <div class="info-box info">
                        No Intune policies are directly assigned to this device or its ${deviceGroupIds.length} groups.
                        (${totalCount} policies exist in tenant)
                    </div>
                `;
            } else {
                infoMessage = `
                    <div class="info-box explanation">
                        Showing <strong>${applicableCount} of ${totalCount}</strong> Intune policies that apply to this device
                        (assigned via "All Devices" or device's ${deviceGroupIds.length} group memberships).
                    </div>
                `;
            }

            return `
                <div class="section" id="section-profiles">
                    <div class="section-header collapsed">
                        <h2>Intune Policies Assigned to Device - ${applicableCount} of ${totalCount} (${applicableProfiles.length} Config, ${applicableCompliance.length} Compliance, ${applicableCatalog.length} Settings Catalog)</h2>
                        <span class="toggle">&#9660;</span>
                    </div>
                    <div class="section-body hidden">
                        <div class="info-box explanation">
                            <strong>What this shows:</strong> Configuration profiles, compliance policies, and settings catalog items assigned to this device from Intune.<br>
                            <strong>Why it matters:</strong> These are the <em>intended</em> policies from your Intune tenant. Compare with "MDM Local State" above to verify they applied.
                        </div>
                        ${infoMessage}
                        ${profilesHtml}
                        ${complianceHtml}
                        ${catalogHtml}
                    </div>
                </div>
            `;
        }

        // Get all group IDs the device is a member of
        function getDeviceGroupIds(groupData) {
            if (!groupData?.Available || !groupData?.DeviceFound || !groupData?.Groups) {
                return [];
            }
            return groupData.Groups.map(g => g.ObjectId).filter(id => id);
        }

        // Check if a policy applies to the device based on assignments
        function policyAppliesToDevice(policy, deviceGroupIds) {
            const assignments = policy.Assignments || [];
            if (assignments.length === 0) return false;

            let isIncluded = false;
            let isExcluded = false;

            for (const assignment of assignments) {
                const targetType = assignment.TargetType || '';
                const groupId = assignment.GroupId;

                // Check for "All Devices" or "All Users" assignments (friendly labels from PowerShell)
                if (targetType === 'All Devices' || targetType === 'All Users') {
                    isIncluded = true;
                }
                // Check for group-based assignment (format: "Group: {groupId}")
                else if (targetType.startsWith('Group:') && groupId && deviceGroupIds.includes(groupId)) {
                    isIncluded = true;
                }
                // Check for exclusion (format: "Exclude: {groupId}")
                else if (targetType.startsWith('Exclude:') && groupId && deviceGroupIds.includes(groupId)) {
                    isExcluded = true;
                }
            }

            return isIncluded && !isExcluded;
        }

        // Get human-readable reason why policy applies
        function getAssignmentReason(policy, deviceGroupIds, groupData) {
            const assignments = policy.Assignments || [];
            const reasons = [];

            for (const assignment of assignments) {
                const targetType = assignment.TargetType || '';
                const groupId = assignment.GroupId;

                if (targetType === 'All Devices') {
                    reasons.push('<span class="status-tag both-match">All Devices</span>');
                } else if (targetType === 'All Users') {
                    reasons.push('<span class="status-tag migration-ready">All Users</span>');
                } else if (targetType.startsWith('Group:') && groupId && deviceGroupIds.includes(groupId)) {
                    // Find group name
                    const group = groupData?.Groups?.find(g => g.ObjectId === groupId);
                    const groupName = group?.DisplayName || 'Group';
                    reasons.push(`<span class="status-tag mdm-only" title="${escapeHtml(groupId)}">${escapeHtml(groupName)}</span>`);
                }
            }

            return reasons.length > 0 ? reasons.join(' ') : '-';
        }

        function formatAssignmentTarget(targetType) {
            if (!targetType) return 'Unknown';
            // Clean up the OData type to human readable
            const type = targetType.replace('#microsoft.graph.', '');
            switch (type) {
                case 'allDevicesAssignmentTarget': return 'All Devices';
                case 'allLicensedUsersAssignmentTarget': return 'All Users';
                case 'groupAssignmentTarget': return 'Group';
                case 'exclusionGroupAssignmentTarget': return 'Exclude Group';
                default: return type.replace(/AssignmentTarget$/, '').replace(/([A-Z])/g, ' $1').trim();
            }
        }

        // Comparison rendering
        function renderCompareView(device1, device2) {
            const container = document.getElementById('compare-content');
            const name1 = device1.device?.computerName || 'Device A';
            const name2 = device2.device?.computerName || 'Device B';

            // Compute diffs
            const gpoDiff = computeGPODiff(device1, device2);
            const mdmDiff = computeMDMDiff(device1, device2);

            const gpo1Count = device1.gpoData?.RegistryPolicies?.length || 0;
            const gpo2Count = device2.gpoData?.RegistryPolicies?.length || 0;
            const mdm1Count = (device1.mdmData?.DevicePolicies?.length || 0) + (device1.mdmData?.UserPolicies?.length || 0);
            const mdm2Count = (device2.mdmData?.DevicePolicies?.length || 0) + (device2.mdmData?.UserPolicies?.length || 0);

            container.innerHTML = `
                <div class="report-header">
                    <h1>Device Comparison</h1>
                    <div class="subtitle">${escapeHtml(name1)} vs ${escapeHtml(name2)}</div>
                </div>

                <div class="legend">
                    <div class="legend-item"><span class="legend-dot red"></span> Unique to ${escapeHtml(name1)}</div>
                    <div class="legend-item"><span class="legend-dot green"></span> Unique to ${escapeHtml(name2)}</div>
                    <div class="legend-item" style="background: rgba(229, 192, 123, 0.15); padding: 5px 10px; border-radius: 4px;">Value Mismatch</div>
                </div>

                <div class="compare-grid">
                    <div class="compare-column">
                        <div class="compare-header">
                            <strong>${escapeHtml(name1)}</strong>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${gpo1Count} GPO, ${mdm1Count} MDM
                            </div>
                        </div>
                    </div>
                    <div class="compare-column">
                        <div class="compare-header">
                            <strong>${escapeHtml(name2)}</strong>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${gpo2Count} GPO, ${mdm2Count} MDM
                            </div>
                        </div>
                    </div>
                </div>

                ${renderGPODiffSection(gpoDiff, name1, name2)}
                ${renderMDMDiffSection(mdmDiff, name1, name2)}
            `;

            initCollapsibles();
        }

        function computeGPODiff(device1, device2) {
            const settings1 = device1.gpoData?.RegistryPolicies || [];
            const settings2 = device2.gpoData?.RegistryPolicies || [];

            const keyFn = (s) => `${s.Path || ''}|${s.ValueName || ''}|${s.Scope || ''}`;

            return computeDiff(settings1, settings2, keyFn, (s) => s.Data);
        }

        function computeMDMDiff(device1, device2) {
            const policies1 = device1.mdmData?.IntunePolicies?.length > 0
                ? device1.mdmData.IntunePolicies
                : [...(device1.mdmData?.DevicePolicies || []), ...(device1.mdmData?.UserPolicies || [])];
            const policies2 = device2.mdmData?.IntunePolicies?.length > 0
                ? device2.mdmData.IntunePolicies
                : [...(device2.mdmData?.DevicePolicies || []), ...(device2.mdmData?.UserPolicies || [])];

            const keyFn = (p) => `${p.Area || ''}|${p.Setting || ''}|${p.Scope || ''}`;

            return computeDiff(policies1, policies2, keyFn, (p) => p.Value);
        }

        function computeDiff(data1, data2, keyFn, valueFn) {
            const map1 = new Map();
            const map2 = new Map();

            data1.forEach(item => map1.set(keyFn(item), { item, value: valueFn(item) }));
            data2.forEach(item => map2.set(keyFn(item), { item, value: valueFn(item) }));

            const result = {
                identical: [],
                valueMismatch: [],
                uniqueToA: [],
                uniqueToB: []
            };

            // Check items in data1
            map1.forEach((entry1, key) => {
                if (map2.has(key)) {
                    const entry2 = map2.get(key);
                    const val1 = JSON.stringify(entry1.value);
                    const val2 = JSON.stringify(entry2.value);

                    if (val1 === val2) {
                        result.identical.push({ key, itemA: entry1.item, itemB: entry2.item });
                    } else {
                        result.valueMismatch.push({ key, itemA: entry1.item, itemB: entry2.item });
                    }
                } else {
                    result.uniqueToA.push({ key, item: entry1.item });
                }
            });

            // Check items only in data2
            map2.forEach((entry2, key) => {
                if (!map1.has(key)) {
                    result.uniqueToB.push({ key, item: entry2.item });
                }
            });

            return result;
        }

        function renderGPODiffSection(diff, name1, name2) {
            const total = diff.identical.length + diff.valueMismatch.length + diff.uniqueToA.length + diff.uniqueToB.length;

            if (total === 0) {
                return `
                    <div class="section">
                        <div class="section-header collapsed">
                            <h2>GPO Comparison - No Settings</h2>
                            <span class="toggle">&#9660;</span>
                        </div>
                        <div class="section-body hidden">
                            <p style="color: var(--text-secondary);">No GPO settings to compare.</p>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="section">
                    <div class="section-header collapsed">
                        <h2>GPO Comparison - ${total} Settings (${diff.identical.length} Identical, ${diff.valueMismatch.length} Mismatched, ${diff.uniqueToA.length}/${diff.uniqueToB.length} Unique)</h2>
                        <span class="toggle">&#9660;</span>
                    </div>
                    <div class="section-body hidden">
                        <div class="summary-grid">
                            <div class="summary-card green">
                                <span class="number">${diff.identical.length}</span>
                                <span class="label">Identical</span>
                            </div>
                            <div class="summary-card yellow">
                                <span class="number">${diff.valueMismatch.length}</span>
                                <span class="label">Value Mismatch</span>
                            </div>
                            <div class="summary-card red">
                                <span class="number">${diff.uniqueToA.length}</span>
                                <span class="label">Only in ${escapeHtml(name1)}</span>
                            </div>
                            <div class="summary-card cyan">
                                <span class="number">${diff.uniqueToB.length}</span>
                                <span class="label">Only in ${escapeHtml(name2)}</span>
                            </div>
                        </div>
                        <div class="filter-bar">
                            <input type="text" id="gpo-diff-search" placeholder="Search GPO comparison..." oninput="filterTable('gpo-diff-table', 'gpo-diff-search')">
                        </div>
                        <div class="table-wrapper">
                            <table id="gpo-diff-table">
                                <thead>
                                    <tr>
                                        <th>Path</th>
                                        <th>Value Name</th>
                                        <th>Value (${escapeHtml(name1)})</th>
                                        <th>Value (${escapeHtml(name2)})</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${diff.valueMismatch.map(d => `
                                        <tr class="diff-value-mismatch">
                                            <td>${escapeHtml(d.itemA.Path || '')}</td>
                                            <td>${escapeHtml(d.itemA.ValueName || '')}</td>
                                            <td>${escapeHtml(formatValue(d.itemA.Data))}</td>
                                            <td>${escapeHtml(formatValue(d.itemB.Data))}</td>
                                            <td><span class="status-tag conflict">Mismatch</span></td>
                                        </tr>
                                    `).join('')}
                                    ${diff.uniqueToA.map(d => `
                                        <tr class="diff-unique-a">
                                            <td>${escapeHtml(d.item.Path || '')}</td>
                                            <td>${escapeHtml(d.item.ValueName || '')}</td>
                                            <td>${escapeHtml(formatValue(d.item.Data))}</td>
                                            <td>-</td>
                                            <td><span class="status-tag no-mapping">Only A</span></td>
                                        </tr>
                                    `).join('')}
                                    ${diff.uniqueToB.map(d => `
                                        <tr class="diff-unique-b">
                                            <td>${escapeHtml(d.item.Path || '')}</td>
                                            <td>${escapeHtml(d.item.ValueName || '')}</td>
                                            <td>-</td>
                                            <td>${escapeHtml(formatValue(d.item.Data))}</td>
                                            <td><span class="status-tag migration-ready">Only B</span></td>
                                        </tr>
                                    `).join('')}
                                    ${diff.identical.map(d => `
                                        <tr class="diff-identical">
                                            <td>${escapeHtml(d.itemA.Path || '')}</td>
                                            <td>${escapeHtml(d.itemA.ValueName || '')}</td>
                                            <td>${escapeHtml(formatValue(d.itemA.Data))}</td>
                                            <td>${escapeHtml(formatValue(d.itemB.Data))}</td>
                                            <td><span class="status-tag both-match">Identical</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMDMDiffSection(diff, name1, name2) {
            const total = diff.identical.length + diff.valueMismatch.length + diff.uniqueToA.length + diff.uniqueToB.length;

            if (total === 0) {
                return `
                    <div class="section">
                        <div class="section-header collapsed">
                            <h2>MDM Comparison - No Policies</h2>
                            <span class="toggle">&#9660;</span>
                        </div>
                        <div class="section-body hidden">
                            <p style="color: var(--text-secondary);">No MDM policies to compare.</p>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="section">
                    <div class="section-header collapsed">
                        <h2>MDM Comparison - ${total} Policies (${diff.identical.length} Identical, ${diff.valueMismatch.length} Mismatched, ${diff.uniqueToA.length}/${diff.uniqueToB.length} Unique)</h2>
                        <span class="toggle">&#9660;</span>
                    </div>
                    <div class="section-body hidden">
                        <div class="summary-grid">
                            <div class="summary-card green">
                                <span class="number">${diff.identical.length}</span>
                                <span class="label">Identical</span>
                            </div>
                            <div class="summary-card yellow">
                                <span class="number">${diff.valueMismatch.length}</span>
                                <span class="label">Value Mismatch</span>
                            </div>
                            <div class="summary-card red">
                                <span class="number">${diff.uniqueToA.length}</span>
                                <span class="label">Only in ${escapeHtml(name1)}</span>
                            </div>
                            <div class="summary-card cyan">
                                <span class="number">${diff.uniqueToB.length}</span>
                                <span class="label">Only in ${escapeHtml(name2)}</span>
                            </div>
                        </div>
                        <div class="filter-bar">
                            <input type="text" id="mdm-diff-search" placeholder="Search MDM comparison..." oninput="filterTable('mdm-diff-table', 'mdm-diff-search')">
                        </div>
                        <div class="table-wrapper">
                            <table id="mdm-diff-table">
                                <thead>
                                    <tr>
                                        <th>Area</th>
                                        <th>Setting</th>
                                        <th>Value (${escapeHtml(name1)})</th>
                                        <th>Value (${escapeHtml(name2)})</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${diff.valueMismatch.map(d => `
                                        <tr class="diff-value-mismatch">
                                            <td>${escapeHtml(d.itemA.Area || '')}</td>
                                            <td>${escapeHtml(d.itemA.Setting || '')}</td>
                                            <td>${escapeHtml(formatValue(d.itemA.Value))}</td>
                                            <td>${escapeHtml(formatValue(d.itemB.Value))}</td>
                                            <td><span class="status-tag conflict">Mismatch</span></td>
                                        </tr>
                                    `).join('')}
                                    ${diff.uniqueToA.map(d => `
                                        <tr class="diff-unique-a">
                                            <td>${escapeHtml(d.item.Area || '')}</td>
                                            <td>${escapeHtml(d.item.Setting || '')}</td>
                                            <td>${escapeHtml(formatValue(d.item.Value))}</td>
                                            <td>-</td>
                                            <td><span class="status-tag no-mapping">Only A</span></td>
                                        </tr>
                                    `).join('')}
                                    ${diff.uniqueToB.map(d => `
                                        <tr class="diff-unique-b">
                                            <td>${escapeHtml(d.item.Area || '')}</td>
                                            <td>${escapeHtml(d.item.Setting || '')}</td>
                                            <td>-</td>
                                            <td>${escapeHtml(formatValue(d.item.Value))}</td>
                                            <td><span class="status-tag migration-ready">Only B</span></td>
                                        </tr>
                                    `).join('')}
                                    ${diff.identical.map(d => `
                                        <tr class="diff-identical">
                                            <td>${escapeHtml(d.itemA.Area || '')}</td>
                                            <td>${escapeHtml(d.itemA.Setting || '')}</td>
                                            <td>${escapeHtml(formatValue(d.itemA.Value))}</td>
                                            <td>${escapeHtml(formatValue(d.itemB.Value))}</td>
                                            <td><span class="status-tag both-match">Identical</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Filtering
        function filterTable(tableId, searchId) {
            const searchValue = document.getElementById(searchId).value.toLowerCase();
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchValue) ? '' : 'none';
            });
        }

        function filterOverlapTable() {
            const searchValue = document.getElementById('overlap-search').value.toLowerCase();
            const statusFilter = document.getElementById('overlap-status-filter').value;
            const table = document.getElementById('overlap-table');
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.dataset.status;
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusFilter || status === statusFilter;
                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });
        }

        // Scroll to section by ID
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                // Expand if collapsed
                const header = section.querySelector('.section-header');
                const body = section.querySelector('.section-body');
                if (header?.classList.contains('collapsed')) {
                    header.classList.remove('collapsed');
                    body?.classList.remove('hidden');
                }
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Collapsible sections
        function initCollapsibles() {
            document.querySelectorAll('.section-header').forEach(header => {
                header.addEventListener('click', function() {
                    this.classList.toggle('collapsed');
                    const body = this.nextElementSibling;
                    body.classList.toggle('hidden');
                });
            });
        }

        // Helpers
        function formatValue(val) {
            if (val === null || val === undefined) return '-';
            if (typeof val === 'object') return JSON.stringify(val);
            return String(val);
        }

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        function formatDate(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                return date.toLocaleString();
            } catch {
                return isoString;
            }
        }

        // Store suggestion data globally for access
        let suggestionData = {};

        // Mapping Suggestions Functions
        function renderSuggestions(overlapItem, suggestions, rowIdx) {
            const suggestionRows = suggestions.map((match, matchIdx) => {
                const confidence = match.Confidence || 'Medium';
                const confidenceClass = confidence.toLowerCase();
                const confidenceIcon = confidence === 'High' ? 'ðŸŸ¢' : confidence === 'Medium' ? 'ðŸŸ¡' : 'ðŸ”´';
                const score = match.Score ? ` (${Math.round(match.Score)}%)` : '';
                const setting = match.Setting || {};
                const displayName = setting.DisplayName || 'Unknown Setting';
                const cspUri = setting.FullCspUri || '';
                const strategies = (match.Strategies || []).join(', ');
                const reasons = (match.Reasons || []).join('; ');

                // Store data for later access
                const dataKey = `${rowIdx}-${matchIdx}`;
                suggestionData[dataKey] = { overlapItem, match };

                return `
                    <div class="suggestion-item">
                        <div class="suggestion-header">
                            <span class="confidence-badge ${confidenceClass}">${confidenceIcon} ${confidence}${score}</span>
                            <span class="suggestion-setting-name">${escapeHtml(displayName)}</span>
                        </div>
                        <div class="suggestion-details">
                            <div class="suggestion-csp-uri">${escapeHtml(cspUri)}</div>
                            ${strategies ? `<div class="suggestion-reasons"><strong>Match Strategy:</strong> ${escapeHtml(strategies)}</div>` : ''}
                            ${reasons ? `<div class="suggestion-reasons"><strong>Reason:</strong> ${escapeHtml(reasons)}</div>` : ''}
                        </div>
                        <div class="suggestion-actions">
                            <button class="btn-copy-mapping" onclick="copyMappingToClipboard('${dataKey}', event)">Quick Copy</button>
                            <button class="btn-view-code" onclick="showMappingCode('${dataKey}', event)">View Code</button>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <tr id="suggestion-${rowIdx}" class="suggestion-row" style="display: none;">
                    <td colspan="6">
                        <div class="suggestions-container visible">
                            ${suggestionRows}
                        </div>
                    </td>
                </tr>
            `;
        }

        function toggleSuggestions(id, event) {
            event.stopPropagation();
            const row = document.getElementById(id);
            if (row) {
                row.style.display = row.style.display === 'none' ? '' : 'none';
            }
        }

        function generateSettingsMapEntry(overlapItem, match) {
            const setting = match.Setting || {};
            const confidence = match.Confidence || 'Medium';
            const gpoPath = (overlapItem.GPOPath || '').replace(/\\/g, '\\\\');
            const cspUri = setting.FullCspUri || '';

            // Extract MDM area and setting from CSP URI
            let mdmArea = '';
            let mdmSetting = '';
            if (cspUri) {
                const parts = cspUri.split('/');
                if (parts.length >= 2) {
                    mdmArea = parts[parts.length - 2];
                    mdmSetting = parts[parts.length - 1];
                }
            }

            const note = confidence === 'High' ? 'AI-suggested mapping - High confidence' :
                         confidence === 'Medium' ? 'AI-suggested mapping - Review recommended' :
                         'AI-suggested mapping - Low confidence, verify carefully';

            return `@{
    GPOPathPattern = '${gpoPath}'
    GPODescription = '${escapeHtml(overlapItem.GPOValueName || '')}'
    MDMArea        = '${mdmArea}'
    MDMSetting     = '${mdmSetting}'
    CSPURI         = '${cspUri}'
    Notes          = '${note}'
}`;
        }

        function copyMappingToClipboard(dataKey, event) {
            event.stopPropagation();
            const data = suggestionData[dataKey];
            if (!data) return;

            const code = generateSettingsMapEntry(data.overlapItem, data.match);

            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ Copied!';
                btn.style.background = 'var(--accent-green)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy to clipboard: ' + err);
            });
        }

        function showMappingCode(dataKey, event) {
            event.stopPropagation();
            const data = suggestionData[dataKey];
            if (!data) return;

            const code = generateSettingsMapEntry(data.overlapItem, data.match);
            document.getElementById('mappingCode').textContent = code;
            document.getElementById('mappingModal').classList.add('active');
        }

        function closeMappingModal() {
            document.getElementById('mappingModal').classList.remove('active');
        }

        function copyModalCode() {
            const code = document.getElementById('mappingCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ Copied!';
                btn.style.background = 'var(--accent-green)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy to clipboard: ' + err);
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('mappingModal');
            if (event.target === modal) {
                closeMappingModal();
            }
        }
    </script>

    <!-- Modal for SettingsMap Code -->
    <div id="mappingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>SettingsMap.psd1 Entry</h3>
                <button class="modal-close" onclick="closeMappingModal()">&times;</button>
            </div>
            <div class="code-block" id="mappingCode"></div>
            <div class="modal-actions">
                <button class="btn-copy-mapping" onclick="copyModalCode()">Copy to Clipboard</button>
                <button class="btn-view-code" onclick="closeMappingModal()">Close</button>
            </div>
        </div>
    </div>
</body>
</html>
