<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolicyLens Viewer v2</title>
    <style>
/* ============================================
   PolicyLens Viewer v2 - Redesigned CSS
   Modern dark theme with Single & Comparison views
   ============================================ */

:root {
    /* Background Colors */
    --bg-primary: #1e1e2e;
    --bg-secondary: #252536;
    --bg-card: #2d2d42;
    --bg-elevated: #343450;
    --bg-hover: #3a3a55;
    --bg-active: #424260;
    
    /* Text Colors */
    --text-primary: #e8e8f0;
    --text-secondary: #a0a0b8;
    --text-muted: #707088;
    --text-inverse: #1e1e2e;
    
    /* Accent Colors */
    --accent-blue: #5b9bd5;
    --accent-blue-light: #7eb3e0;
    --accent-blue-dark: #4a8ac4;
    --accent-green: #6bc96b;
    --accent-green-light: #8ad88a;
    --accent-green-dark: #5ab85a;
    --accent-yellow: #e5c07b;
    --accent-yellow-light: #f0d090;
    --accent-yellow-dark: #d4af6a;
    --accent-red: #e06c75;
    --accent-red-light: #eb8b92;
    --accent-red-dark: #cf5b64;
    --accent-cyan: #56b6c2;
    --accent-cyan-light: #75c7d1;
    --accent-cyan-dark: #45a5b1;
    --accent-magenta: #c678dd;
    --accent-magenta-light: #d499e8;
    --accent-magenta-dark: #b567cc;
    --accent-orange: #d19a66;
    
    /* Semantic Colors */
    --status-applied: var(--accent-green);
    --status-missing: var(--accent-red);
    --status-different: var(--accent-yellow);
    --status-info: var(--accent-blue);
    
    /* Border Colors */
    --border-subtle: #3a3a55;
    --border-default: #454565;
    --border-strong: #555575;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
    --shadow-glow-blue: 0 0 20px rgba(91, 155, 213, 0.15);
    --shadow-glow-green: 0 0 20px rgba(107, 201, 107, 0.15);
    
    /* Spacing */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;
    
    /* Border Radius */
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --radius-full: 9999px;
    
    /* Transitions */
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    
    /* Typography */
    --font-sans: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
    --font-mono: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    --font-size-xs: 0.75rem;
    --font-size-sm: 0.875rem;
    --font-size-base: 1rem;
    --font-size-lg: 1.125rem;
    --font-size-xl: 1.25rem;
    --font-size-2xl: 1.5rem;
    --font-size-3xl: 1.875rem;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: var(--font-sans);
    font-size: var(--font-size-base);
    line-height: 1.5;
    color: var(--text-primary);
    background-color: var(--bg-primary);
    min-height: 100vh;
    padding: var(--space-lg);
    max-width: 1800px;
    margin: 0 auto;
}

/* Navigation Bar */
.nav-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-lg);
    gap: var(--space-md);
    flex-wrap: wrap;
}

.nav-bar h1 {
    font-size: var(--font-size-xl);
    font-weight: 600;
    color: var(--accent-blue);
    margin: 0;
}

.nav-bar h1::before { content: "üîç "; }

.nav-actions { display: flex; gap: var(--space-sm); flex-wrap: wrap; }

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
    border: 1px solid transparent;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
}

.btn:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-primary {
    background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-blue-dark) 100%);
    color: var(--text-inverse);
    border-color: var(--accent-blue-dark);
}

.btn-primary:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--accent-blue-light) 0%, var(--accent-blue) 100%);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-secondary {
    background: var(--bg-card);
    color: var(--text-primary);
    border-color: var(--border-default);
}

.btn-secondary:hover:not(:disabled) { background: var(--bg-hover); }
.btn-secondary.active { background: var(--accent-blue); color: var(--text-inverse); }

/* Summary Cards */
.summary-section { margin-bottom: var(--space-lg); }

.summary-section-header {
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    margin-bottom: var(--space-md);
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: var(--space-md);
}

.summary-card {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    text-align: center;
    transition: all var(--transition-normal);
}

.summary-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

.summary-card .number {
    display: block;
    font-size: var(--font-size-3xl);
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: var(--space-xs);
}

.summary-card .label { font-size: var(--font-size-sm); color: var(--text-secondary); }
.summary-card .description { font-size: var(--font-size-xs); color: var(--text-muted); margin-top: var(--space-xs); }

.summary-card.green .number { color: var(--accent-green); }
.summary-card.red .number { color: var(--accent-red); }
.summary-card.yellow .number { color: var(--accent-yellow); }
.summary-card.blue .number { color: var(--accent-blue); }
.summary-card.cyan .number { color: var(--accent-cyan); }
.summary-card.magenta .number { color: var(--accent-magenta); }

/* Status Tags */
.status-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    border-radius: var(--radius-sm);
}

.status-tag.both-match, .status-tag.match { background: rgba(107, 201, 107, 0.15); color: var(--accent-green); }
.status-tag.conflict { background: rgba(224, 108, 117, 0.15); color: var(--accent-red); }
.status-tag.no-mapping { background: rgba(198, 120, 221, 0.15); color: var(--accent-magenta); }

/* Badges */
.badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    border-radius: var(--radius-full);
}

.badge-enrolled { background: var(--accent-green); color: var(--text-inverse); }
.badge-not-enrolled { background: var(--accent-yellow); color: var(--text-inverse); }

/* Tables */
.table-wrapper { overflow-x: auto; max-height: 500px; overflow-y: auto; }

table { width: 100%; border-collapse: collapse; font-size: var(--font-size-sm); }

th {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    font-weight: 600;
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    background: var(--bg-card);
    border-bottom: 2px solid var(--border-default);
    position: sticky;
    top: 0;
    z-index: 10;
}

td {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border-subtle);
    vertical-align: middle;
}

tbody tr:hover { background: var(--bg-hover); }

tr.status-both-match td:first-child, tr.status-match td:first-child { border-left: 3px solid var(--accent-green); }
tr.status-both-conflict td:first-child, tr.status-conflict td:first-child { border-left: 3px solid var(--accent-red); background: rgba(224, 108, 117, 0.05); }
tr.status-gpo-mapping td:first-child { border-left: 3px solid var(--accent-cyan); }
tr.status-gpo-nomapping td:first-child { border-left: 3px solid var(--accent-magenta); }

.path-cell { font-size: var(--font-size-xs); font-family: var(--font-mono); color: var(--text-secondary); }
.monospace { font-family: var(--font-mono); font-size: var(--font-size-xs); }

/* Filter Bar */
.filter-bar { display: flex; gap: var(--space-sm); margin-bottom: var(--space-md); flex-wrap: wrap; }

.filter-bar input, .filter-bar select {
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    background: var(--bg-card);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
}

.filter-bar input { flex: 1; min-width: 200px; }
.filter-bar input:focus, .filter-bar select:focus { outline: none; border-color: var(--accent-blue); }

/* Collapsible Sections */
.section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-md);
    overflow: hidden;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    background: var(--bg-card);
    cursor: pointer;
    user-select: none;
    transition: background var(--transition-fast);
}

.section-header:hover { background: var(--bg-hover); }

.section-header h2 {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.section-header .toggle {
    font-size: 12px;
    color: var(--text-muted);
    transition: transform var(--transition-normal);
}

.section-header.collapsed .toggle { transform: rotate(-90deg); }

.section-body { padding: var(--space-lg); }
.section-body.hidden { display: none; }

/* Source Tabs */
.tabs, .source-tabs {
    display: flex;
    gap: var(--space-xs);
    padding: var(--space-xs);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-subtle);
    margin-bottom: var(--space-lg);
}

.tab {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--text-secondary);
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.tab:hover { background: var(--bg-hover); color: var(--text-primary); }
.tab.active { background: var(--bg-card); color: var(--text-primary); box-shadow: var(--shadow-sm); }

.source-tab-content { display: none; }
.source-tab-content.active { display: block; }

/* Report Header */
.report-header {
    border-bottom: 2px solid var(--accent-blue);
    padding-bottom: var(--space-md);
    margin-bottom: var(--space-lg);
}

.report-header h1 {
    font-size: var(--font-size-2xl);
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.report-header .subtitle { color: var(--text-secondary); font-size: var(--font-size-sm); }
.header-separator { margin: 0 var(--space-sm); color: var(--text-muted); }

/* Callouts & Info Boxes */
.callout {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
}

.callout.warning { background: rgba(224, 108, 117, 0.1); border: 1px solid rgba(224, 108, 117, 0.3); }
.callout.info { background: rgba(86, 182, 194, 0.1); border: 1px solid rgba(86, 182, 194, 0.3); }

.callout-icon { font-size: var(--font-size-xl); }
.callout-text { font-size: var(--font-size-sm); }

.info-box {
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-sm);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
    border-left: 3px solid;
}

.info-box.info, .info-box.explanation { background: rgba(91, 155, 213, 0.08); border-color: var(--accent-blue); color: var(--text-secondary); }
.info-box.warning { background: rgba(229, 192, 123, 0.1); border-color: var(--accent-yellow); }
.info-box.success { background: rgba(107, 201, 107, 0.1); border-color: var(--accent-green); }

/* Legend Box */
.legend-box {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
}

.legend-item { display: flex; align-items: center; gap: var(--space-sm); }

.legend-color { width: 16px; height: 16px; border-radius: var(--radius-sm); flex-shrink: 0; }
.legend-color.match { background: var(--accent-green); }
.legend-color.conflict { background: var(--accent-red); }
.legend-color.migration { background: var(--accent-cyan); }
.legend-color.nomapping { background: var(--accent-magenta); }

.legend-label { font-weight: 500; font-size: var(--font-size-sm); }
.legend-desc { font-size: var(--font-size-xs); color: var(--text-muted); }

/* Drop Zone */
.drop-zone {
    padding: var(--space-2xl);
    text-align: center;
    border: 2px dashed var(--border-default);
    border-radius: var(--radius-xl);
    background: var(--bg-secondary);
    transition: all var(--transition-normal);
    cursor: pointer;
}

.drop-zone:hover { border-color: var(--accent-blue); background: rgba(91, 155, 213, 0.05); }
.drop-zone.drag-over { border-color: var(--accent-blue); background: rgba(91, 155, 213, 0.1); box-shadow: var(--shadow-glow-blue); }

.drop-zone h2 { font-size: var(--font-size-xl); color: var(--text-primary); margin-bottom: var(--space-sm); }
.drop-zone p { color: var(--text-muted); margin-bottom: var(--space-lg); }

/* Device Cards */
.device-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-md); }

.device-card {
    position: relative;
    padding: var(--space-md);
    background: var(--bg-card);
    border: 2px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.device-card:hover { border-color: var(--accent-blue); transform: translateY(-2px); box-shadow: var(--shadow-md); }
.device-card.selected { border-color: var(--accent-green); background: rgba(107, 201, 107, 0.08); box-shadow: var(--shadow-glow-green); }

.device-card .name { font-weight: 600; margin-bottom: var(--space-xs); }
.device-card .info { font-size: var(--font-size-xs); color: var(--text-muted); margin-bottom: var(--space-xs); }

.device-card .remove {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: var(--accent-red);
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    opacity: 0;
    transition: opacity var(--transition-fast);
}

.device-card:hover .remove { opacity: 1; }
.device-card .remove:hover { background: var(--accent-red); color: var(--text-inverse); }

/* Welcome Panel */
.welcome-panel {
    padding: var(--space-xl);
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-lg);
}

.welcome-panel h2 { font-size: var(--font-size-xl); color: var(--accent-blue); margin-bottom: var(--space-md); }
.welcome-panel p { color: var(--text-secondary); margin-bottom: var(--space-md); line-height: 1.7; }
.welcome-panel ul { list-style: none; }
.welcome-panel li { padding: var(--space-xs) 0; padding-left: var(--space-lg); position: relative; color: var(--text-primary); }
.welcome-panel li::before { content: "‚Üí"; position: absolute; left: 0; color: var(--accent-blue); }

/* Enrollment & Group Grids */
.enrollment-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--space-md); }
.enrollment-item .key { font-size: var(--font-size-xs); text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 2px; }
.enrollment-item .value { font-size: var(--font-size-sm); word-break: break-all; }

.group-list { display: flex; flex-wrap: wrap; gap: var(--space-sm); }

.group-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    font-size: var(--font-size-xs);
    background: var(--bg-card);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-full);
}

.group-chip.dynamic { border-color: var(--accent-cyan); color: var(--accent-cyan); }
.group-chip.assigned { border-color: var(--accent-blue); color: var(--accent-blue); }

/* App Cards & Grids */
.app-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-md); }

.app-card {
    padding: var(--space-md);
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
}

.app-card .app-name { font-weight: 600; margin-bottom: var(--space-xs); }
.app-card .app-type { font-size: var(--font-size-xs); color: var(--text-muted); margin-bottom: var(--space-sm); }

.app-card .app-intent {
    display: inline-block;
    padding: 2px 8px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    border-radius: var(--radius-sm);
}

.app-card .app-intent.required { background: rgba(91, 155, 213, 0.15); color: var(--accent-blue); }
.app-card .app-intent.available { background: rgba(107, 201, 107, 0.15); color: var(--accent-green); }

/* GPO List */
.gpo-list { display: flex; flex-direction: column; gap: var(--space-sm); }
.gpo-item { padding: var(--space-sm) var(--space-md); background: var(--bg-card); border-radius: var(--radius-md); display: flex; align-items: center; gap: var(--space-md); }
.gpo-name { font-weight: 500; }
.gpo-link-order { font-size: var(--font-size-xs); color: var(--text-muted); }

/* Scope Badges */
.scope-badge { font-size: var(--font-size-xs); padding: 2px 8px; border-radius: var(--radius-sm); background: var(--bg-elevated); }
.scope-badge.scope-machine { color: var(--accent-cyan); }
.scope-badge.scope-user { color: var(--accent-magenta); }
.scope-badge.scope-device { color: var(--accent-cyan); }

.group-type-badge { font-size: var(--font-size-xs); padding: 2px 8px; border-radius: var(--radius-sm); }
.group-type-badge.dynamic { background: rgba(86, 182, 194, 0.15); color: var(--accent-cyan); }
.group-type-badge.assigned { background: rgba(91, 155, 213, 0.15); color: var(--accent-blue); }

/* View Containers */
.view { display: none; }
.view.active { display: block; }

/* Comparison View Specific */
.comparison-row.row-different { background: rgba(229, 192, 123, 0.1); }
.comparison-row.row-different td:first-child { border-left: 3px solid var(--accent-yellow); }
.comparison-row.row-identical { opacity: 0.8; }

.cell-applied { color: var(--accent-green); }
.cell-not-applied { color: var(--accent-red); opacity: 0.6; }
.cell-required { color: var(--accent-yellow); font-weight: 600; }
.cell-available { color: var(--accent-green); }
.cell-installed { color: var(--accent-green); }
.cell-not-installed { color: var(--accent-red); }
.cell-compliant { color: var(--accent-green); }
.cell-noncompliant { color: var(--accent-red); }
.cell-member { color: var(--accent-green); }
.cell-not-member { color: var(--accent-red); opacity: 0.6; }
.cell-dynamic { color: var(--accent-cyan); font-style: italic; }
.cell-assigned { color: var(--accent-blue); }

.comparison-table td { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.comparison-table td:hover { white-space: normal; word-break: break-word; }

/* Footer */
.report-footer {
    margin-top: var(--space-xl);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-subtle);
    text-align: center;
    font-size: var(--font-size-xs);
    color: var(--text-muted);
}

/* Scrollbars */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* Responsive */
@media (max-width: 768px) {
    body { padding: var(--space-md); }
    .nav-bar { flex-direction: column; text-align: center; }
    .summary-grid { grid-template-columns: repeat(2, 1fr); }
    .filter-bar { flex-direction: column; }
    .filter-bar input { width: 100%; }
}

/* Print */
@media print {
    body { background: white; color: #1a1a1a; }
    .nav-bar, .drop-zone, .btn, .filter-bar { display: none !important; }
    .section-body { display: block !important; }
}
    </style>
</head>
<body>
    <div class="nav-bar">
        <h1>PolicyLens Viewer</h1>
        <div class="nav-actions">
            <button class="btn btn-secondary" onclick="showView('upload')" id="nav-upload">Upload Files</button>
            <button class="btn btn-secondary" onclick="showView('single')" id="nav-single" disabled>Single View</button>
            <button class="btn btn-secondary" onclick="showView('compare')" id="nav-compare" disabled>Compare (2-3)</button>
        </div>
    </div>

    <!-- Upload View -->
    <div id="view-upload" class="view active">
        <div class="welcome-panel">
            <h2>üìä Welcome to PolicyLens Viewer v2</h2>
            <p>Analyze Windows device policy configurations across GPO, Intune, SCCM, and Azure AD.</p>
            <ul>
                <li><strong>Single View:</strong> Deep-dive into one device's complete policy landscape</li>
                <li><strong>Comparison View:</strong> Compare 2-3 devices side-by-side to find differences</li>
                <li>See conflicts, matches, and migration opportunities at a glance</li>
            </ul>
        </div>

        <input type="file" id="file-input" accept=".json" multiple style="display: none;">
        <div class="drop-zone" id="drop-zone">
            <h2>üìÅ Drop PolicyLens JSON Files Here</h2>
            <p>or click to browse</p>
            <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">Browse Files</button>
        </div>

        <div style="margin-top: var(--space-lg);">
            <h3 style="color: var(--text-secondary); margin-bottom: var(--space-md);">Loaded Devices</h3>
            <div class="device-cards" id="device-cards">
                <p style="color: var(--text-muted);">No devices loaded yet.</p>
            </div>
        </div>

        <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-sm); flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="viewSelectedDevice()" id="btn-view-single" disabled>View Selected Device</button>
            <button class="btn btn-primary" onclick="compareSelectedDevices()" id="btn-compare" disabled>Compare Selected (2-3)</button>
        </div>
    </div>

    <!-- Single Device View -->
    <div id="view-single" class="view">
        <div id="single-content"></div>
    </div>

    <!-- Compare View -->
    <div id="view-compare" class="view">
        <div id="compare-content"></div>
    </div>

    <div class="report-footer">
        PolicyLens Viewer v2 - Multi-source policy analysis for Windows devices
    </div>

    <script>
// ============================================================================
// APPLICATION STATE
// ============================================================================
const AppState = {
    devices: [],
    currentView: 'upload',
    selectedDevices: []
};

// ============================================================================
// INITIALIZATION
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    initDropZone();
    initFileInput();
});

function initDropZone() {
    const dropZone = document.getElementById('drop-zone');
    
    dropZone.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') {
            document.getElementById('file-input').click();
        }
    });

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        processFiles(e.dataTransfer.files);
    });
}

function initFileInput() {
    document.getElementById('file-input').addEventListener('change', (e) => {
        processFiles(e.target.files);
        e.target.value = '';
    });
}

// ============================================================================
// FILE HANDLING
// ============================================================================
function processFiles(files) {
    for (const file of files) {
        if (file.type === 'application/json' || file.name.endsWith('.json')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && data.schemaVersion === "1.0") {
                        const exists = AppState.devices.some(d =>
                            d.device?.computerName === data.device?.computerName &&
                            d.exportedAt === data.exportedAt
                        );
                        if (!exists) {
                            AppState.devices.push(data);
                            renderDeviceCards();
                        } else {
                            alert(`Device "${data.device?.computerName || 'Unknown'}" already loaded.`);
                        }
                    } else {
                        alert(`Invalid schema in ${file.name}. Expected schemaVersion "1.0".`);
                    }
                } catch (err) {
                    alert(`Error parsing ${file.name}: ${err.message}`);
                }
            };
            reader.readAsText(file);
        }
    }
}

// ============================================================================
// DEVICE CARD RENDERING
// ============================================================================
function renderDeviceCards() {
    const container = document.getElementById('device-cards');

    if (AppState.devices.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted);">No devices loaded yet.</p>';
        updateNavButtons();
        return;
    }

    container.innerHTML = AppState.devices.map((device, index) => {
        const name = device.device?.computerName || 'Unknown Device';
        const date = device.exportedAt ? formatDate(device.exportedAt) : 'Unknown date';
        const gpoCount = device.gpoData?.TotalGPOCount || 0;
        const gpoSettings = device.gpoData?.RegistryPolicies?.length || 0;
        const mdmCount = (device.mdmData?.DevicePolicies?.length || 0) + (device.mdmData?.UserPolicies?.length || 0);
        const isSelected = AppState.selectedDevices.includes(index);

        return `
            <div class="device-card ${isSelected ? 'selected' : ''}" onclick="selectDevice(${index})">
                <span class="remove" onclick="removeDevice(${index}, event)">&times;</span>
                <div class="name">${escapeHtml(name)}</div>
                <div class="info">${escapeHtml(date)}</div>
                <div class="info">${gpoCount} GPOs (${gpoSettings} settings) | ${mdmCount} MDM policies</div>
            </div>
        `;
    }).join('');

    updateNavButtons();
}

function selectDevice(index) {
    const idx = AppState.selectedDevices.indexOf(index);
    if (idx > -1) {
        AppState.selectedDevices.splice(idx, 1);
    } else {
        if (AppState.selectedDevices.length >= 3) {
            AppState.selectedDevices.shift();
        }
        AppState.selectedDevices.push(index);
    }
    renderDeviceCards();
}

function removeDevice(index, e) {
    e.stopPropagation();
    AppState.devices.splice(index, 1);
    AppState.selectedDevices = AppState.selectedDevices
        .filter(i => i !== index)
        .map(i => i > index ? i - 1 : i);
    renderDeviceCards();
}

function updateNavButtons() {
    const btnSingle = document.getElementById('btn-view-single');
    const btnCompare = document.getElementById('btn-compare');
    const navSingle = document.getElementById('nav-single');
    const navCompare = document.getElementById('nav-compare');

    btnSingle.disabled = AppState.selectedDevices.length !== 1;
    btnCompare.disabled = AppState.selectedDevices.length < 2;
    navSingle.disabled = AppState.devices.length === 0;
    navCompare.disabled = AppState.devices.length < 2;
}

// ============================================================================
// VIEW SWITCHING
// ============================================================================
function showView(viewName) {
    AppState.currentView = viewName;
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(`view-${viewName}`).classList.add('active');

    document.querySelectorAll('.nav-actions .btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`nav-${viewName}`)?.classList.add('active');
}

function viewSelectedDevice() {
    if (AppState.selectedDevices.length === 1) {
        const device = AppState.devices[AppState.selectedDevices[0]];
        document.getElementById('single-content').innerHTML = renderSingleView(device);
        initSingleView();
        showView('single');
    }
}

function compareSelectedDevices() {
    if (AppState.selectedDevices.length >= 2) {
        const devices = AppState.selectedDevices.map(i => AppState.devices[i]);
        document.getElementById('compare-content').innerHTML = renderComparisonView(devices);
        initCollapsibles();
        showView('compare');
    }
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================
function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(str);
    return div.innerHTML;
}

function formatDate(isoString) {
    if (!isoString) return '';
    try {
        return new Date(isoString).toLocaleString();
    } catch {
        return isoString;
    }
}

function formatValue(val) {
    if (val === null || val === undefined) return '-';
    if (typeof val === 'object') return JSON.stringify(val);
    return String(val);
}

function initCollapsibles() {
    document.querySelectorAll('.section-header').forEach(header => {
        if (header.dataset.initialized) return;
        header.dataset.initialized = 'true';
        header.addEventListener('click', function() {
            this.classList.toggle('collapsed');
            const body = this.nextElementSibling;
            if (body) body.classList.toggle('hidden');
        });
    });
}

function filterTable(tableId, searchValue) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const search = searchValue.toLowerCase();
    table.querySelectorAll('tbody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(search) ? '' : 'none';
    });
}

function filterTableBySearch(tableId, searchInputId) {
    const searchValue = (document.getElementById(searchInputId)?.value || '').toLowerCase();
    const table = document.getElementById(tableId);
    if (!table) return;
    table.querySelectorAll('tbody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(searchValue) ? '' : 'none';
    });
}

// ============================================================================
// GROUP & POLICY HELPERS
// ============================================================================
function getDeviceGroupIds(groupData) {
    if (!groupData?.Available || !groupData?.DeviceFound || !groupData?.Groups) return [];
    return groupData.Groups.map(g => g.ObjectId).filter(id => id);
}

function policyAppliesToDevice(policy, deviceGroupIds) {
    const assignments = policy.Assignments || [];
    if (assignments.length === 0) return false;
    
    let isIncluded = false, isExcluded = false;
    
    for (const a of assignments) {
        const targetType = (a.TargetType || '').replace('#microsoft.graph.', '');
        const groupId = a.GroupId;
        
        if (targetType === 'allDevicesAssignmentTarget' || targetType === 'allLicensedUsersAssignmentTarget') {
            isIncluded = true;
        } else if (targetType === 'groupAssignmentTarget' && groupId && deviceGroupIds.includes(groupId)) {
            isIncluded = true;
        } else if (targetType === 'exclusionGroupAssignmentTarget' && groupId && deviceGroupIds.includes(groupId)) {
            isExcluded = true;
        }
    }
    
    return isIncluded && !isExcluded;
}

function appAppliesToDevice(app, deviceGroupIds) {
    return (app.Assignments || []).some(a => assignmentAppliesToDevice(a, deviceGroupIds));
}

function assignmentAppliesToDevice(assignment, deviceGroupIds) {
    const targetType = assignment.TargetType || '';
    const groupId = assignment.GroupId;
    
    if (targetType === 'All Devices' || targetType === 'All Users') return true;
    if (targetType.startsWith('Group:') && groupId && deviceGroupIds.includes(groupId)) return true;
    return false;
}

function filterApplicablePolicies(policies, deviceGroupIds) {
    return policies.filter(p => policyAppliesToDevice(p, deviceGroupIds));
}

function getAssignmentReason(policy, deviceGroupIds, groupData) {
    const groups = groupData?.Groups || [];
    const assignments = policy.Assignments || [];
    
    for (const a of assignments) {
        const targetType = (a.TargetType || '').replace('#microsoft.graph.', '');
        if (targetType === 'allDevicesAssignmentTarget') return 'All Devices';
        if (targetType === 'allLicensedUsersAssignmentTarget') return 'All Users';
        if (targetType === 'groupAssignmentTarget' && a.GroupId && deviceGroupIds.includes(a.GroupId)) {
            const group = groups.find(g => g.ObjectId === a.GroupId);
            return group ? escapeHtml(group.DisplayName) : 'Group';
        }
    }
    return '-';
}

function formatProfileType(odataType) {
    if (!odataType) return 'Unknown';
    return odataType.replace('#microsoft.graph.', '').replace(/([A-Z])/g, ' $1').trim();
}

function formatAssignmentTarget(targetType, groupId, groupData) {
    if (targetType === 'All Devices') return '<span class="badge">All Devices</span>';
    if (targetType === 'All Users') return '<span class="badge">All Users</span>';
    const groups = groupData?.Groups || [];
    const group = groups.find(g => g.ObjectId === groupId);
    return group ? escapeHtml(group.DisplayName) : 'Group';
}

function getProfileType(profile) {
    if (profile.OdataType) return formatProfileType(profile.OdataType);
    if (profile.Technologies) return 'Settings Catalog';
    return 'Unknown';
}

// ============================================================================
// SINGLE VIEW RENDERING
// ============================================================================
function renderSingleView(deviceData) {
    const device = deviceData.device || {};
    const name = device.computerName || 'Unknown Device';
    const osVersion = device.osVersion || 'Unknown OS';
    const enrolled = deviceData.mdmData?.IsEnrolled || false;
    const exportDate = deviceData.exportedAt ? formatDate(deviceData.exportedAt) : 'Unknown';

    const enrolledBadge = enrolled 
        ? '<span class="badge badge-enrolled">MDM Enrolled</span>'
        : '<span class="badge badge-not-enrolled">Not Enrolled</span>';

    return `
        <div class="single-view-container">
            <div class="report-header">
                <h1>${escapeHtml(name)} ${enrolledBadge}</h1>
                <div class="subtitle">
                    <span>OS: ${escapeHtml(osVersion)}</span>
                    <span class="header-separator">|</span>
                    <span>Exported: ${escapeHtml(exportDate)}</span>
                </div>
            </div>
            
            <div class="source-tabs" id="source-tabs">
                <button class="tab active" data-tab="gpo" onclick="switchSourceTab('gpo')">üìã GPO</button>
                <button class="tab" data-tab="intune" onclick="switchSourceTab('intune')">‚òÅÔ∏è Intune/MDM</button>
                <button class="tab" data-tab="sccm" onclick="switchSourceTab('sccm')">üñ•Ô∏è SCCM</button>
                <button class="tab" data-tab="azuread" onclick="switchSourceTab('azuread')">üîê Azure AD</button>
            </div>
            
            <div class="tab-content-container">
                ${renderGPOTab(deviceData)}
                ${renderIntuneTab(deviceData)}
                ${renderSCCMTab(deviceData)}
                ${renderAzureADTab(deviceData)}
            </div>
            
            ${renderMigrationAnalysis(deviceData)}
        </div>
    `;
}

function switchSourceTab(tabId) {
    document.querySelectorAll('#source-tabs .tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabId);
    });
    document.querySelectorAll('.source-tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabId}`);
    });
}

function initSingleView() {
    initCollapsibles();
    switchSourceTab('gpo');
}

// GPO Tab
function renderGPOTab(deviceData) {
    const gpoData = deviceData.gpoData || {};
    const totalGPOs = gpoData.TotalGPOCount || 0;
    const registryPolicies = gpoData.RegistryPolicies || [];
    const appliedGPOs = gpoData.AppliedGPOs || [];

    return `
        <div class="source-tab-content active" id="tab-gpo">
            <div class="summary-grid" style="margin-bottom: var(--space-lg);">
                <div class="summary-card blue">
                    <span class="number">${totalGPOs}</span>
                    <span class="label">GPOs Applied</span>
                </div>
                <div class="summary-card cyan">
                    <span class="number">${registryPolicies.length}</span>
                    <span class="label">Registry Settings</span>
                </div>
            </div>
            
            ${appliedGPOs.length > 0 ? `
                <div class="section">
                    <div class="section-header">
                        <h2>Applied GPOs (${appliedGPOs.length})</h2>
                        <span class="toggle">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <div class="gpo-list">
                            ${appliedGPOs.map(gpo => `
                                <div class="gpo-item">
                                    <span class="gpo-name">${escapeHtml(gpo.Name || gpo.DisplayName || 'Unknown')}</span>
                                    ${gpo.LinkOrder ? `<span class="gpo-link-order">Link: ${gpo.LinkOrder}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : totalGPOs > 0 ? `<div class="info-box info">${totalGPOs} GPO(s) detected. Names not available.</div>` : ''}
            
            ${registryPolicies.length > 0 ? `
                <div class="section">
                    <div class="section-header">
                        <h2>Registry Settings (${registryPolicies.length})</h2>
                        <span class="toggle">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <div class="filter-bar">
                            <input type="text" id="gpo-search" placeholder="Search settings..." oninput="filterTable('gpo-registry-table', this.value)">
                            <select id="gpo-scope" onchange="filterGPOByScope()">
                                <option value="">All Scopes</option>
                                <option value="Machine">Machine</option>
                                <option value="User">User</option>
                            </select>
                        </div>
                        <div class="table-wrapper">
                            <table id="gpo-registry-table">
                                <thead><tr><th>Category</th><th>Path</th><th>Value Name</th><th>Value</th><th>Scope</th></tr></thead>
                                <tbody>
                                    ${registryPolicies.map(p => `
                                        <tr data-scope="${escapeHtml(p.Scope || '')}">
                                            <td>${escapeHtml(p.Category || '-')}</td>
                                            <td class="path-cell">${escapeHtml(p.Path || '-')}</td>
                                            <td>${escapeHtml(p.ValueName || '-')}</td>
                                            <td>${escapeHtml(formatValue(p.Data))}</td>
                                            <td><span class="scope-badge scope-${(p.Scope || '').toLowerCase()}">${escapeHtml(p.Scope || '-')}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            ` : '<div class="info-box warning">No GPO registry settings found.</div>'}
        </div>
    `;
}

function filterGPOByScope() {
    const search = (document.getElementById('gpo-search')?.value || '').toLowerCase();
    const scope = document.getElementById('gpo-scope')?.value || '';
    const table = document.getElementById('gpo-registry-table');
    if (!table) return;
    
    table.querySelectorAll('tbody tr').forEach(row => {
        const matchesSearch = row.textContent.toLowerCase().includes(search);
        const matchesScope = !scope || row.dataset.scope === scope;
        row.style.display = (matchesSearch && matchesScope) ? '' : 'none';
    });
}

// Intune Tab
function renderIntuneTab(deviceData) {
    const mdmData = deviceData.mdmData || {};
    const isEnrolled = mdmData.IsEnrolled || false;
    const devicePolicies = mdmData.DevicePolicies || [];
    const userPolicies = mdmData.UserPolicies || [];
    const allPolicies = [...devicePolicies, ...userPolicies];

    return `
        <div class="source-tab-content" id="tab-intune">
            <div class="summary-grid" style="margin-bottom: var(--space-lg);">
                <div class="summary-card ${isEnrolled ? 'green' : 'yellow'}">
                    <span class="number">${isEnrolled ? '‚úì' : '‚úó'}</span>
                    <span class="label">Enrollment</span>
                </div>
                <div class="summary-card blue">
                    <span class="number">${allPolicies.length}</span>
                    <span class="label">MDM Policies</span>
                </div>
            </div>
            
            ${!isEnrolled ? `
                <div class="callout warning">
                    <span class="callout-icon">‚ö†Ô∏è</span>
                    <span class="callout-text">Device is not MDM enrolled. Intune policies cannot be applied.</span>
                </div>
            ` : ''}
            
            ${allPolicies.length > 0 ? `
                <div class="section">
                    <div class="section-header">
                        <h2>MDM Policy Settings (${allPolicies.length})</h2>
                        <span class="toggle">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <div class="filter-bar">
                            <input type="text" id="mdm-search" placeholder="Search policies..." oninput="filterTable('mdm-policies-table', this.value)">
                        </div>
                        <div class="table-wrapper">
                            <table id="mdm-policies-table">
                                <thead><tr><th>Area</th><th>Setting</th><th>Value</th><th>Scope</th></tr></thead>
                                <tbody>
                                    ${allPolicies.map(p => `
                                        <tr>
                                            <td>${escapeHtml(p.Area || '-')}</td>
                                            <td>${escapeHtml(p.Setting || '-')}</td>
                                            <td>${escapeHtml(formatValue(p.Value))}</td>
                                            <td><span class="scope-badge scope-${(p.Scope || '').toLowerCase()}">${escapeHtml(p.Scope || '-')}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// SCCM Tab
function renderSCCMTab(deviceData) {
    const sccmData = deviceData.sccmData || {};
    const isInstalled = sccmData.IsInstalled || false;

    if (!isInstalled) {
        return `
            <div class="source-tab-content" id="tab-sccm">
                <div class="summary-grid" style="margin-bottom: var(--space-lg);">
                    <div class="summary-card yellow">
                        <span class="number">‚úó</span>
                        <span class="label">SCCM Client</span>
                    </div>
                </div>
                <div class="callout warning">
                    <span class="callout-icon">‚ö†Ô∏è</span>
                    <span class="callout-text">SCCM/ConfigMgr client is not installed on this device.</span>
                </div>
            </div>
        `;
    }

    const apps = sccmData.Applications || [];
    const baselines = sccmData.Baselines || [];

    return `
        <div class="source-tab-content" id="tab-sccm">
            <div class="summary-grid" style="margin-bottom: var(--space-lg);">
                <div class="summary-card green">
                    <span class="number">‚úì</span>
                    <span class="label">SCCM Client</span>
                </div>
                <div class="summary-card blue">
                    <span class="number">${apps.length}</span>
                    <span class="label">Applications</span>
                </div>
                <div class="summary-card cyan">
                    <span class="number">${baselines.length}</span>
                    <span class="label">Baselines</span>
                </div>
            </div>
            
            ${apps.length > 0 ? `
                <div class="section">
                    <div class="section-header">
                        <h2>Applications (${apps.length})</h2>
                        <span class="toggle">‚ñº</span>
                    </div>
                    <div class="section-body">
                        <div class="table-wrapper">
                            <table>
                                <thead><tr><th>Name</th><th>Publisher</th><th>Version</th><th>State</th></tr></thead>
                                <tbody>
                                    ${apps.map(a => `
                                        <tr>
                                            <td><strong>${escapeHtml(a.Name || '-')}</strong></td>
                                            <td>${escapeHtml(a.Publisher || '-')}</td>
                                            <td>${escapeHtml(a.Version || '-')}</td>
                                            <td><span class="status-tag ${a.InstallState === 'Installed' ? 'both-match' : 'no-mapping'}">${escapeHtml(a.InstallState || '-')}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// Azure AD Tab
function renderAzureADTab(deviceData) {
    const groupData = deviceData.groupData || {};

    if (!groupData.Available || !groupData.DeviceFound) {
        return `
            <div class="source-tab-content" id="tab-azuread">
                <div class="summary-grid" style="margin-bottom: var(--space-lg);">
                    <div class="summary-card yellow">
                        <span class="number">?</span>
                        <span class="label">Azure AD</span>
                    </div>
                </div>
                <div class="callout warning">
                    <span class="callout-icon">‚ö†Ô∏è</span>
                    <span class="callout-text">Azure AD group data not available. Run export with -IncludeGraph.</span>
                </div>
            </div>
        `;
    }

    const groups = groupData.Groups || [];
    const dynamicGroups = groups.filter(g => g.GroupType === 'Dynamic');
    const assignedGroups = groups.filter(g => g.GroupType !== 'Dynamic');

    return `
        <div class="source-tab-content" id="tab-azuread">
            <div class="summary-grid" style="margin-bottom: var(--space-lg);">
                <div class="summary-card blue">
                    <span class="number">${groups.length}</span>
                    <span class="label">Total Groups</span>
                </div>
                <div class="summary-card cyan">
                    <span class="number">${dynamicGroups.length}</span>
                    <span class="label">Dynamic</span>
                </div>
                <div class="summary-card magenta">
                    <span class="number">${assignedGroups.length}</span>
                    <span class="label">Assigned</span>
                </div>
            </div>
            
            ${groups.length > 0 ? `
                <div class="section">
                    <div class="section-header">
                        <h2>Group Memberships (${groups.length})</h2>
                        <span class="toggle">‚ñº</span>
                    </div>
                    <div class="section-body">
                        ${dynamicGroups.length > 0 ? `
                            <h3 style="margin-bottom: var(--space-sm); color: var(--accent-cyan);">Dynamic (${dynamicGroups.length})</h3>
                            <div class="group-list" style="margin-bottom: var(--space-md);">
                                ${dynamicGroups.map(g => `<span class="group-chip dynamic">${escapeHtml(g.DisplayName || 'Unknown')}</span>`).join('')}
                            </div>
                        ` : ''}
                        ${assignedGroups.length > 0 ? `
                            <h3 style="margin-bottom: var(--space-sm); color: var(--accent-blue);">Assigned (${assignedGroups.length})</h3>
                            <div class="group-list">
                                ${assignedGroups.map(g => `<span class="group-chip assigned">${escapeHtml(g.DisplayName || 'Unknown')}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : '<div class="info-box info">No group memberships found.</div>'}
        </div>
    `;
}

// Migration Analysis
function renderMigrationAnalysis(deviceData) {
    const analysis = deviceData.analysis || {};
    const summary = analysis.Summary || {};
    const matches = summary.BothConfiguredMatch || 0;
    const conflicts = summary.ValuesInConflict || 0;
    const migrationReady = summary.GPOOnlyWithMapping || 0;
    const noMapping = summary.GPOOnlyNoMapping || 0;
    const total = matches + conflicts + migrationReady + noMapping;

    if (total === 0) return '';

    return `
        <div class="section migration-section" style="margin-top: var(--space-xl);">
            <div class="section-header collapsed">
                <h2>üìä Migration Analysis (${total} settings)</h2>
                <span class="toggle">‚ñº</span>
            </div>
            <div class="section-body hidden">
                <div class="info-box explanation">GPO vs Intune/MDM policy overlap analysis.</div>
                <div class="summary-grid">
                    <div class="summary-card green">
                        <span class="number">${matches}</span>
                        <span class="label">Matches</span>
                    </div>
                    <div class="summary-card red">
                        <span class="number">${conflicts}</span>
                        <span class="label">Conflicts</span>
                    </div>
                    <div class="summary-card cyan">
                        <span class="number">${migrationReady}</span>
                        <span class="label">Migration Ready</span>
                    </div>
                    <div class="summary-card magenta">
                        <span class="number">${noMapping}</span>
                        <span class="label">No Mapping</span>
                    </div>
                </div>
                ${conflicts > 0 ? `
                    <div class="callout warning" style="margin-top: var(--space-md);">
                        <span class="callout-icon">‚ö†Ô∏è</span>
                        <span class="callout-text"><strong>${conflicts} conflict(s)</strong> - Different values in GPO vs Intune. Review before migration.</span>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// ============================================================================
// COMPARISON VIEW RENDERING
// ============================================================================
function renderComparisonView(devices) {
    if (!devices || devices.length < 2 || devices.length > 3) {
        return '<div class="info-box warning">Please select 2 or 3 devices to compare.</div>';
    }

    const deviceNames = devices.map(d => d.device?.computerName || 'Unknown');
    
    const gpoComparison = compareGPOSettings(devices);
    const intuneComparison = compareIntuneSettings(devices);
    const sccmComparison = compareSCCMSettings(devices);
    const azureADComparison = compareAzureADGroups(devices);
    
    const summary = {
        gpo: gpoComparison.differences,
        intune: intuneComparison.differences,
        sccm: sccmComparison.differences,
        azureAD: azureADComparison.differences,
        total: gpoComparison.differences + intuneComparison.differences + 
               sccmComparison.differences + azureADComparison.differences
    };

    return `
        <div class="report-header">
            <h1>Device Comparison</h1>
            <div class="subtitle">${deviceNames.map(n => escapeHtml(n)).join(' vs ')}</div>
        </div>
        
        <div class="summary-section">
            <div class="summary-section-header">Comparison Summary - ${deviceNames.length} Devices</div>
            <div class="summary-grid">
                <div class="summary-card ${summary.total > 0 ? 'red' : 'green'}">
                    <span class="number">${summary.total}</span>
                    <span class="label">Total Differences</span>
                </div>
                <div class="summary-card ${summary.gpo > 0 ? 'yellow' : 'green'}">
                    <span class="number">${summary.gpo}</span>
                    <span class="label">GPO</span>
                </div>
                <div class="summary-card ${summary.intune > 0 ? 'yellow' : 'green'}">
                    <span class="number">${summary.intune}</span>
                    <span class="label">Intune</span>
                </div>
                <div class="summary-card ${summary.sccm > 0 ? 'yellow' : 'green'}">
                    <span class="number">${summary.sccm}</span>
                    <span class="label">SCCM</span>
                </div>
                <div class="summary-card ${summary.azureAD > 0 ? 'yellow' : 'green'}">
                    <span class="number">${summary.azureAD}</span>
                    <span class="label">Azure AD</span>
                </div>
            </div>
        </div>
        
        <div class="filter-bar" style="margin-bottom: var(--space-lg);">
            <label style="display: flex; align-items: center; gap: var(--space-sm); cursor: pointer;">
                <input type="checkbox" id="hide-identical-rows" onchange="toggleIdenticalRows(this.checked)">
                <span>Show differences only</span>
            </label>
        </div>
        
        ${renderGPOComparisonSection(gpoComparison, deviceNames)}
        ${renderIntuneComparisonSection(intuneComparison, deviceNames)}
        ${renderSCCMComparisonSection(sccmComparison, deviceNames)}
        ${renderAzureADComparisonSection(azureADComparison, deviceNames)}
    `;
}

function toggleIdenticalRows(hide) {
    document.querySelectorAll('.comparison-row.row-identical').forEach(row => {
        row.style.display = hide ? 'none' : '';
    });
}

// GPO Comparison
function compareGPOSettings(devices) {
    const gpoObjects = compareGPOObjects(devices);
    const registrySettings = compareRegistrySettings(devices);
    return {
        gpoObjects,
        registrySettings,
        differences: gpoObjects.filter(r => r.hasDifference).length + registrySettings.filter(r => r.hasDifference).length
    };
}

function compareGPOObjects(devices) {
    const allGPOs = new Map();
    devices.forEach((device, idx) => {
        (device.gpoData?.AppliedGPOs || []).forEach(gpo => {
            const key = gpo.Name || gpo.DisplayName || 'Unknown';
            if (!allGPOs.has(key)) allGPOs.set(key, { name: key, devices: new Array(devices.length).fill(null) });
            allGPOs.get(key).devices[idx] = gpo;
        });
    });
    
    return Array.from(allGPOs.values()).map(entry => ({
        name: entry.name,
        cells: entry.devices.map(d => d ? { applied: true, value: '‚úì' } : { applied: false, value: '‚úó' }),
        hasDifference: entry.devices.filter(d => d !== null).length > 0 && entry.devices.filter(d => d !== null).length < devices.length
    })).sort((a, b) => b.hasDifference - a.hasDifference || a.name.localeCompare(b.name));
}

function compareRegistrySettings(devices) {
    const allSettings = new Map();
    devices.forEach((device, idx) => {
        (device.gpoData?.RegistryPolicies || []).forEach(s => {
            const key = `${s.Path || ''}|${s.ValueName || ''}`;
            if (!allSettings.has(key)) allSettings.set(key, { path: s.Path || '', valueName: s.ValueName || '', devices: new Array(devices.length).fill(null) });
            allSettings.get(key).devices[idx] = s;
        });
    });
    
    return Array.from(allSettings.values()).map(entry => {
        const values = entry.devices.map(d => d ? formatValue(d.Data) : null);
        const nonNull = values.filter(v => v !== null);
        const unique = [...new Set(nonNull)];
        return {
            path: entry.path,
            valueName: entry.valueName,
            cells: entry.devices.map(d => ({ applied: d !== null, value: d ? formatValue(d.Data) : '‚úó' })),
            hasDifference: nonNull.length !== devices.length || unique.length > 1
        };
    }).sort((a, b) => b.hasDifference - a.hasDifference);
}

function renderGPOComparisonSection(comparison, deviceNames) {
    const total = comparison.gpoObjects.length + comparison.registrySettings.length;
    return `
        <div class="section">
            <div class="section-header">
                <h2>üìã GPO Comparison (${comparison.differences} differences of ${total})</h2>
                <span class="toggle">‚ñº</span>
            </div>
            <div class="section-body">
                ${comparison.gpoObjects.length > 0 ? `
                    <h3 style="margin-bottom: var(--space-sm); color: var(--text-secondary);">Applied GPOs</h3>
                    ${renderComparisonTable(['GPO Name', ...deviceNames], comparison.gpoObjects.map(r => ({
                        cells: [r.name, ...r.cells.map(c => c.value)],
                        hasDifference: r.hasDifference,
                        cellClasses: ['', ...r.cells.map(c => c.applied ? 'cell-applied' : 'cell-not-applied')]
                    })))}
                ` : ''}
                <h3 style="margin: var(--space-lg) 0 var(--space-sm); color: var(--text-secondary);">Registry Settings</h3>
                ${comparison.registrySettings.length > 0 ? renderComparisonTable(['Path', 'Value Name', ...deviceNames], comparison.registrySettings.map(r => ({
                    cells: [r.path, r.valueName, ...r.cells.map(c => c.value)],
                    hasDifference: r.hasDifference,
                    cellClasses: ['path-cell', '', ...r.cells.map(c => c.applied ? 'cell-applied' : 'cell-not-applied')]
                }))) : '<p style="color: var(--text-muted);">No registry settings.</p>'}
            </div>
        </div>
    `;
}

// Intune Comparison
function compareIntuneSettings(devices) {
    const mdmPolicies = compareMDMPolicies(devices);
    return { mdmPolicies, differences: mdmPolicies.filter(r => r.hasDifference).length };
}

function compareMDMPolicies(devices) {
    const allPolicies = new Map();
    devices.forEach((device, idx) => {
        [...(device.mdmData?.DevicePolicies || []), ...(device.mdmData?.UserPolicies || [])].forEach(p => {
            const key = `${p.Area || ''}|${p.Setting || ''}`;
            if (!allPolicies.has(key)) allPolicies.set(key, { area: p.Area || '', setting: p.Setting || '', devices: new Array(devices.length).fill(null) });
            allPolicies.get(key).devices[idx] = p;
        });
    });
    
    return Array.from(allPolicies.values()).map(entry => {
        const values = entry.devices.map(d => d ? formatValue(d.Value) : null);
        const nonNull = values.filter(v => v !== null);
        const unique = [...new Set(nonNull)];
        return {
            area: entry.area,
            setting: entry.setting,
            cells: entry.devices.map(d => ({ applied: d !== null, value: d ? formatValue(d.Value) : '‚úó' })),
            hasDifference: nonNull.length !== devices.length || unique.length > 1
        };
    }).sort((a, b) => b.hasDifference - a.hasDifference);
}

function renderIntuneComparisonSection(comparison, deviceNames) {
    return `
        <div class="section">
            <div class="section-header">
                <h2>‚òÅÔ∏è Intune/MDM Comparison (${comparison.differences} differences of ${comparison.mdmPolicies.length})</h2>
                <span class="toggle">‚ñº</span>
            </div>
            <div class="section-body">
                ${comparison.mdmPolicies.length > 0 ? renderComparisonTable(['Area', 'Setting', ...deviceNames], comparison.mdmPolicies.map(r => ({
                    cells: [r.area, r.setting, ...r.cells.map(c => c.value)],
                    hasDifference: r.hasDifference,
                    cellClasses: ['', '', ...r.cells.map(c => c.applied ? 'cell-applied' : 'cell-not-applied')]
                }))) : '<p style="color: var(--text-muted);">No MDM policies found.</p>'}
            </div>
        </div>
    `;
}

// SCCM Comparison
function compareSCCMSettings(devices) {
    const apps = compareSCCMApps(devices);
    return { apps, differences: apps.filter(r => r.hasDifference).length };
}

function compareSCCMApps(devices) {
    const allApps = new Map();
    devices.forEach((device, idx) => {
        (device.sccmData?.Applications || []).forEach(a => {
            const key = a.Name || 'Unknown';
            if (!allApps.has(key)) allApps.set(key, { name: key, devices: new Array(devices.length).fill(null) });
            allApps.get(key).devices[idx] = a;
        });
    });
    
    return Array.from(allApps.values()).map(entry => ({
        name: entry.name,
        cells: entry.devices.map(d => d ? { applied: true, value: d.InstallState || '‚úì' } : { applied: false, value: '‚úó' }),
        hasDifference: entry.devices.filter(d => d !== null).length !== devices.length
    })).sort((a, b) => b.hasDifference - a.hasDifference);
}

function renderSCCMComparisonSection(comparison, deviceNames) {
    return `
        <div class="section">
            <div class="section-header ${comparison.apps.length === 0 ? 'collapsed' : ''}">
                <h2>üñ•Ô∏è SCCM Comparison (${comparison.differences} differences of ${comparison.apps.length})</h2>
                <span class="toggle">‚ñº</span>
            </div>
            <div class="section-body ${comparison.apps.length === 0 ? 'hidden' : ''}">
                ${comparison.apps.length > 0 ? renderComparisonTable(['Application', ...deviceNames], comparison.apps.map(r => ({
                    cells: [r.name, ...r.cells.map(c => c.value)],
                    hasDifference: r.hasDifference,
                    cellClasses: ['', ...r.cells.map(c => c.applied ? (c.value === 'Installed' ? 'cell-installed' : 'cell-applied') : 'cell-not-applied')]
                }))) : '<p style="color: var(--text-muted);">No SCCM data.</p>'}
            </div>
        </div>
    `;
}

// Azure AD Comparison
function compareAzureADGroups(devices) {
    const allGroups = new Map();
    devices.forEach((device, idx) => {
        (device.groupData?.Groups || []).forEach(g => {
            const key = g.ObjectId || g.DisplayName;
            if (!allGroups.has(key)) allGroups.set(key, { name: g.DisplayName || 'Unknown', type: g.GroupType || 'Assigned', devices: new Array(devices.length).fill(false) });
            allGroups.get(key).devices[idx] = true;
        });
    });
    
    const groups = Array.from(allGroups.values()).map(entry => ({
        name: entry.name,
        type: entry.type,
        cells: entry.devices.map(d => ({ applied: d, value: d ? '‚úì' : '‚úó' })),
        hasDifference: entry.devices.filter(d => d).length > 0 && entry.devices.filter(d => d).length < devices.length
    })).sort((a, b) => b.hasDifference - a.hasDifference);
    
    return { groups, differences: groups.filter(r => r.hasDifference).length };
}

function renderAzureADComparisonSection(comparison, deviceNames) {
    return `
        <div class="section">
            <div class="section-header ${comparison.groups.length === 0 ? 'collapsed' : ''}">
                <h2>üîê Azure AD Groups (${comparison.differences} differences of ${comparison.groups.length})</h2>
                <span class="toggle">‚ñº</span>
            </div>
            <div class="section-body ${comparison.groups.length === 0 ? 'hidden' : ''}">
                ${comparison.groups.length > 0 ? renderComparisonTable(['Group Name', 'Type', ...deviceNames], comparison.groups.map(r => ({
                    cells: [r.name, r.type, ...r.cells.map(c => c.value)],
                    hasDifference: r.hasDifference,
                    cellClasses: ['', r.type === 'Dynamic' ? 'cell-dynamic' : 'cell-assigned', ...r.cells.map(c => c.applied ? 'cell-member' : 'cell-not-member')]
                }))) : '<p style="color: var(--text-muted);">No Azure AD groups.</p>'}
            </div>
        </div>
    `;
}

// Comparison Table Renderer
function renderComparisonTable(headers, rows) {
    if (rows.length === 0) return '<p style="color: var(--text-muted);">No items.</p>';
    return `
        <div class="table-wrapper">
            <table class="comparison-table">
                <thead><tr>${headers.map(h => `<th>${escapeHtml(h)}</th>`).join('')}</tr></thead>
                <tbody>
                    ${rows.map(row => `
                        <tr class="comparison-row ${row.hasDifference ? 'row-different' : 'row-identical'}">
                            ${row.cells.map((cell, i) => `<td class="${row.cellClasses?.[i] || ''}">${escapeHtml(cell)}</td>`).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function filterComparisonTable(tableId, searchText) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const search = searchText.toLowerCase();
    const hideIdentical = document.getElementById('hide-identical-rows')?.checked;
    table.querySelectorAll('tbody tr').forEach(row => {
        const matchesSearch = row.textContent.toLowerCase().includes(search);
        const isIdentical = row.classList.contains('row-identical');
        row.style.display = matchesSearch && !(isIdentical && hideIdentical) ? '' : 'none';
    });
}
    </script>
</body>
</html>
