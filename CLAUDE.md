# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

PolicyCheck is a PowerShell module that scans Windows devices for applied Group Policy (GPO) and Intune/MDM policies, analyzes overlap between them, and generates HTML reports to assist with GPO-to-Intune migration.

## Running the Tool

```powershell
# Basic local scan
.\PolicyCheck.ps1

# With Graph API (Intune profiles, apps, groups)
.\PolicyCheck.ps1 -IncludeGraph

# Export JSON for web viewer
.\PolicyCheck.ps1 -ExportJson
```

Requires Windows 10/11 and PowerShell 5.1+. Run as Administrator for full results.

## Module Architecture

**Entry Points:**
- `PolicyCheck.ps1` - Standalone script wrapper that imports the module and runs `Invoke-PolicyCheck`
- `PolicyCheck.psd1` / `PolicyCheck.psm1` - Module manifest and loader (dot-sources Public/ and Private/ scripts)

**Public Functions** (exported, in `Public/`):
- `Invoke-PolicyCheck` - Main orchestrator that runs all phases and generates output
- `Get-GPOPolicyData` - Collects GPO data via gpresult and registry scanning
- `Get-MDMPolicyData` - Reads MDM enrollment and PolicyManager registry keys
- `Get-GraphPolicyData` - Fetches Intune profiles via Microsoft Graph
- `Get-DeviceAppAssignments` - Gets Intune app assignments via Graph
- `Get-DeviceGroupMemberships` - Gets Azure AD group memberships via Graph
- `Compare-PolicyOverlap` - Cross-references GPO settings against MDM using SettingsMap

**Private Functions** (internal, in `Private/`):
- `ConvertTo-HtmlReport` - Generates self-contained HTML report with embedded CSS/JS
- `ConvertTo-JsonExport` - Exports results to JSON for the web viewer tool
- `Write-ConsoleSummary` - Outputs color-coded summary to console
- `Merge-PolicyData` - Helper for combining policy data

**Data Flow:**
1. `Invoke-PolicyCheck` calls data collection functions (GPO, MDM, optionally Graph)
2. `Compare-PolicyOverlap` analyzes settings using `Config/SettingsMap.psd1` mapping
3. Results flow to `Write-ConsoleSummary`, `ConvertTo-HtmlReport`, and optionally `ConvertTo-JsonExport`

## Key Files

| Path | Purpose |
|------|---------|
| `Config/SettingsMap.psd1` | GPO-to-Intune CSP mapping definitions (extensible) |
| `Templates/report.css` | Styles embedded into HTML reports |
| `Tools/PolicyCheckViewer.html` | Self-contained web viewer for JSON exports |

## Extending the Settings Map

Add entries to `Config/SettingsMap.psd1`:
```powershell
@{
    CategoryName = @(
        @{
            GPOPathPattern = 'Registry\\Path\\Pattern'  # Regex to match GPO registry path
            MDMArea        = 'CSPAreaName'              # Intune CSP area
            MDMSetting     = 'SettingName'              # Intune CSP setting name
            CSPURI         = './Device/Vendor/MSFT/...' # Full CSP URI
        }
    )
}
```

## Output Formats

- **HTML Report** - Generated by default, self-contained with embedded CSS/JS
- **JSON Export** - Use `-ExportJson` parameter, view with `Tools/PolicyCheckViewer.html`
- **PSCustomObject** - Returned to pipeline for programmatic access
